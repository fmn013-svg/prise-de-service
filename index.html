<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PdS FMN">
<title>Prise de Service â€” FMN</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS â€” Apple-grade system
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:       #001E62;
  --navy-mid:   #0A3080;
  --navy-light: #E8EDF8;
  --red:        #C8102E;
  --red-light:  #FDEAED;
  --green:      #1A7A3C;
  --green-light:#E6F5EC;
  --amber:      #C97B00;
  --amber-light:#FFF5DC;
  --blue:       #006BDE;
  --blue-light: #E5F0FF;
  --teal:       #005F73;
  --teal-light: #E0F2F5;

  --bg:         #F2F4F8;
  --surface:    #FFFFFF;
  --surface2:   #F7F8FA;
  --border:     rgba(0,0,0,.08);
  --border2:    rgba(0,0,0,.05);
  --shadow-sm:  0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
  --shadow-md:  0 4px 16px rgba(0,0,0,.10), 0 2px 6px rgba(0,0,0,.07);
  --shadow-lg:  0 12px 40px rgba(0,0,0,.14), 0 4px 12px rgba(0,0,0,.08);

  --text:       #0D1421;
  --text2:      #3D4A5C;
  --text3:      #7A8699;
  --text-inv:   #FFFFFF;

  --radius-sm:  8px;
  --radius-md:  14px;
  --radius-lg:  20px;
  --radius-xl:  28px;

  --tab-h:      56px;
  --hdr-h:      100px;
  --btm-h:      80px;

  --safe-top:    env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* â•â•â• RESET â•â•â• */
*,*::before,*::after {
  box-sizing: border-box; margin: 0; padding: 0;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}
html, body {
  height: 100%; overflow: hidden;
  font-family: -apple-system, 'Helvetica Neue', sans-serif;
  background: var(--bg); color: var(--text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-size: 16px;
}

/* â•â•â• LAYOUT â•â•â• */
#APP { display: flex; flex-direction: column; height: 100vh; height: -webkit-fill-available; overflow: hidden; }

/* â•â•â• HEADER â•â•â• */
#HDR {
  flex-shrink: 0;
  background: var(--navy);
  padding-top: calc(var(--safe-top) + 12px);
  position: relative;
  overflow: hidden;
  z-index: 30;
}
#HDR::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, #001E62 0%, #0A3080 60%, #003399 100%);
  z-index: 0;
}
#HDR::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--red) 0%, #FF3355 50%, var(--red) 100%);
  z-index: 2;
}
.hdr-content {
  position: relative; z-index: 1;
  display: flex; align-items: center;
  gap: 14px; padding: 0 18px 14px;
}
.hdr-badge {
  width: 46px; height: 46px; border-radius: 12px;
  background: var(--red);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(200,16,46,.4);
}
.hdr-title { flex: 1; min-width: 0; }
.hdr-title h1 {
  font-size: 17px; font-weight: 700; color: #fff;
  letter-spacing: -.3px;
}
.hdr-title p {
  font-size: 11px; color: rgba(255,255,255,.55);
  margin-top: 1px; letter-spacing: .2px;
}
.hdr-actions { display: flex; gap: 8px; }
.icon-btn {
  width: 38px; height: 38px; border: none; border-radius: 10px;
  background: rgba(255,255,255,.12); color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; cursor: pointer;
  transition: background .15s;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}
.icon-btn:active { background: rgba(255,255,255,.25); transform: scale(.94); }

/* â•â•â• PROGRESS BAR â•â•â• */
#PROGRESS-WRAP {
  position: relative; z-index: 1;
  padding: 0 18px 12px;
  display: flex; align-items: center; gap: 10px;
}
.progress-bar-bg {
  flex: 1; height: 4px; border-radius: 2px;
  background: rgba(255,255,255,.2); overflow: hidden;
}
.progress-bar-fill {
  height: 100%; border-radius: 2px;
  background: linear-gradient(90deg, #fff 0%, rgba(255,255,255,.7) 100%);
  transition: width .4s cubic-bezier(.4,0,.2,1);
  width: 0%;
}
.progress-pct {
  font-size: 11px; font-weight: 700; color: rgba(255,255,255,.7);
  min-width: 32px; text-align: right;
}

/* â•â•â• TABS â•â•â• */
#TABS {
  flex-shrink: 0;
  display: flex;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: relative; z-index: 20;
}
.tab {
  flex: 1; height: var(--tab-h);
  border: none; background: transparent; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 2px; position: relative;
  transition: opacity .2s;
}
.tab-ico { font-size: 18px; transition: transform .2s; }
.tab-lbl {
  font-size: 10px; font-weight: 600; color: var(--text3);
  letter-spacing: .2px; transition: color .2s;
}
.tab.on .tab-ico { transform: scale(1.1); }
.tab.on .tab-lbl { color: var(--navy); font-weight: 700; }
.tab.on::after {
  content: '';
  position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 24px; height: 3px; border-radius: 2px;
  background: var(--navy);
}

/* â•â•â• VIEWS â•â•â• */
#VIEWS { flex: 1; overflow: hidden; position: relative; }
.view {
  position: absolute; inset: 0;
  overflow-y: auto; -webkit-overflow-scrolling: touch;
  padding: 16px 16px calc(var(--btm-h) + var(--safe-bottom) + 24px);
  display: none;
}
.view.on {
  display: block;
  animation: viewIn .22s cubic-bezier(.4,0,.2,1) both;
}
@keyframes viewIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â•â•â• SECTION CARDS â•â•â• */
.section {
  background: var(--surface); border-radius: var(--radius-lg);
  margin-bottom: 12px; overflow: hidden;
  border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm);
}
.section-header {
  display: flex; align-items: center; gap: 10px;
  padding: 13px 16px; background: var(--surface);
  border-bottom: 1px solid var(--border2);
}
.section-num {
  width: 26px; height: 26px; border-radius: 50%;
  background: var(--navy); color: #fff;
  font-size: 11px; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.section-title {
  font-size: 12px; font-weight: 700;
  color: var(--navy); text-transform: uppercase;
  letter-spacing: .6px; flex: 1;
}
.section-badge {
  font-size: 10px; font-weight: 700;
  padding: 3px 8px; border-radius: 20px;
}

/* â•â•â• ROWS â•â•â• */
.row {
  display: flex; align-items: center; gap: 12px;
  padding: 13px 16px;
  border-bottom: 1px solid var(--border2);
  min-height: 54px;
  transition: background .15s;
}
.row:last-child { border-bottom: none; }
.row:active { background: var(--surface2); }
.row-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
.row-right { flex-shrink: 0; display: flex; align-items: center; gap: 8px; }
.row-full { flex-direction: column; align-items: flex-start; gap: 10px; }
.row-label { font-size: 14px; font-weight: 600; color: var(--text); line-height: 1.3; }
.row-sub { font-size: 12px; color: var(--text3); margin-top: 2px; }

/* â•â•â• INDICATOR DOT â•â•â• */
.dot {
  width: 12px; height: 12px; border-radius: 50%;
  background: var(--border); flex-shrink: 0;
  transition: background .2s, box-shadow .2s;
}
.dot.ok { background: var(--green); box-shadow: 0 0 0 3px var(--green-light); }
.dot.ko { background: var(--red); box-shadow: 0 0 0 3px var(--red-light); }
.dot.warn { background: var(--amber); box-shadow: 0 0 0 3px var(--amber-light); }
.dot.info { background: var(--blue); box-shadow: 0 0 0 3px var(--blue-light); }

/* â•â•â• INPUTS â•â•â• */
input, select, textarea {
  font-family: -apple-system, 'Helvetica Neue', sans-serif;
  font-size: 14px; color: var(--text);
  background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); padding: 9px 12px; outline: none;
  -webkit-appearance: none; appearance: none;
  transition: border-color .2s, box-shadow .2s, background .2s;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--navy); background: var(--surface);
  box-shadow: 0 0 0 3px var(--navy-light);
}
input[type=text] { min-width: 110px; max-width: 150px; }
input[type=date] { min-width: 140px; }
input[type=time] { min-width: 95px; }
textarea { width: 100%; min-height: 80px; resize: vertical; line-height: 1.5; }
select {
  min-width: 130px; padding-right: 32px; cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M0.5 0.5L5 5.5L9.5 0.5' stroke='%237A8699' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
select.ok-select {
  border-color: var(--green); background-color: var(--green-light);
  color: var(--green); font-weight: 700;
}
select.ko-select {
  border-color: var(--red); background-color: var(--red-light);
  color: var(--red); font-weight: 700;
}

/* â•â•â• KVB GRID â•â•â• */
.kvb-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 10px; padding: 10px 16px 14px 38px;
}
.kvb-item label {
  font-size: 10px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .5px;
  display: block; margin-bottom: 4px;
}
.subsec-label {
  font-size: 10px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .5px;
  padding: 8px 16px 6px 38px;
  background: var(--surface2);
  border-bottom: 1px solid var(--border2);
}

/* â•â•â• HD BOX â•â•â• */
.hd-display {
  font-size: 26px; font-weight: 800; color: var(--navy);
  background: var(--navy-light); border: 2px solid rgba(0,30,98,.2);
  border-radius: var(--radius-sm); padding: 6px 16px;
  letter-spacing: 3px; min-width: 96px; text-align: center;
  font-variant-numeric: tabular-nums;
}

/* â•â•â• STATUS BANNER â•â•â• */
.status-banner {
  display: flex; align-items: center; gap: 8px;
  padding: 11px 16px; margin: 0 0 0;
  font-size: 13px; font-weight: 700;
  transition: background .3s, color .3s;
  background: var(--surface2); color: var(--text3);
}
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

/* â•â•â• ALERT BLOCKS â•â•â• */
.alert {
  display: flex; align-items: flex-start; gap: 10px;
  margin: 0 16px 12px; padding: 12px 14px;
  border-radius: var(--radius-md); font-size: 13px;
  font-weight: 600; line-height: 1.5;
  animation: fadeIn .2s ease;
}
.alert.danger { background: var(--red-light); color: var(--red); border-left: 3px solid var(--red); }
.alert.warn   { background: var(--amber-light); color: var(--amber); border-left: 3px solid var(--amber); }
.alert.info   { background: var(--blue-light); color: var(--blue); border-left: 3px solid var(--blue); }
.alert.ok     { background: var(--green-light); color: var(--green); border-left: 3px solid var(--green); }
.alert.teal   { background: var(--teal-light); color: var(--teal); border-left: 3px solid var(--teal); }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

/* â•â•â• TIMESTAMP BLOCK â•â•â• */
.ts-block {
  padding: 12px 16px 14px 38px;
  border-bottom: 1px solid var(--border2);
  display: flex; flex-direction: column; gap: 8px;
}
.ts-lbl { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: .5px; }
.ts-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.ts-hint { font-size: 11px; color: var(--text3); font-style: italic; }

/* â•â•â• BUTTONS â•â•â• */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  border: none; border-radius: var(--radius-md);
  font-family: -apple-system, 'Helvetica Neue', sans-serif;
  font-weight: 700; cursor: pointer;
  transition: transform .12s, filter .12s, box-shadow .12s;
  -webkit-tap-highlight-color: transparent;
}
.btn:active { transform: scale(.96); filter: brightness(.9); }
.btn-primary {
  background: var(--navy); color: #fff;
  width: 100%; padding: 16px; font-size: 15px;
  box-shadow: 0 4px 16px rgba(0,30,98,.3);
  border-radius: var(--radius-md);
}
.btn-danger  { background: var(--red); color: #fff; flex: 1; padding: 14px 12px; font-size: 14px; }
.btn-sec     { background: var(--surface2); color: var(--text2); flex: 1; padding: 14px 12px; font-size: 14px; border: 1px solid var(--border); }
.btn-teal    { background: var(--teal); color: #fff; flex: 1; padding: 14px 12px; font-size: 14px; }
.btn-sm {
  padding: 9px 13px; border-radius: var(--radius-sm);
  font-size: 12px; font-weight: 700; color: #fff; border: none; cursor: pointer;
  transition: filter .15s, transform .1s;
}
.btn-sm:active { filter: brightness(.85); transform: scale(.95); }
.btn-navy-sm { background: var(--navy-mid); }
.btn-green-sm { background: var(--green); }
.btn-reset-all {
  width: 100%; background: transparent; color: var(--red);
  border: 1.5px solid var(--red); padding: 12px;
  font-size: 14px; font-weight: 700;
  border-radius: var(--radius-md); cursor: pointer;
  font-family: -apple-system, sans-serif;
  transition: background .15s;
}
.btn-reset-all:active { background: var(--red-light); }

/* â•â•â• BOTTOM BAR â•â•â• */
#BTM {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 12px 16px calc(12px + var(--safe-bottom));
  display: flex; flex-direction: column; gap: 8px;
  box-shadow: 0 -4px 20px rgba(0,0,0,.08);
  z-index: 40;
}
.btn-row { display: flex; gap: 8px; }

/* â•â•â• TOAST â•â•â• */
#TOAST {
  position: fixed; top: calc(var(--safe-top) + var(--hdr-h) + 12px);
  left: 50%; transform: translateX(-50%) translateY(-8px);
  padding: 11px 20px; border-radius: 24px;
  font-size: 13px; font-weight: 700; z-index: 999;
  opacity: 0; pointer-events: none;
  transition: opacity .25s cubic-bezier(.4,0,.2,1), transform .25s cubic-bezier(.4,0,.2,1);
  white-space: nowrap; max-width: 90vw; text-align: center;
  box-shadow: var(--shadow-lg);
}
#TOAST.on { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â•â•â• OVERLAY / SHEET â•â•â• */
#OVL {
  position: fixed; inset: 0;
  background: rgba(10,20,50,.55);
  z-index: 200; display: flex; align-items: flex-end;
  opacity: 0; pointer-events: none;
  transition: opacity .3s;
  -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
}
#OVL.on { opacity: 1; pointer-events: all; }
.sheet {
  background: var(--surface); width: 100%;
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  padding: 8px 20px calc(24px + var(--safe-bottom));
  transform: translateY(100%);
  transition: transform .35s cubic-bezier(.32,1,.23,1);
  max-height: 85vh; overflow-y: auto;
}
#OVL.on .sheet { transform: translateY(0); }
.sh-handle {
  width: 36px; height: 4px; background: var(--border);
  border-radius: 2px; margin: 10px auto 18px;
}
.sh-title { font-size: 18px; font-weight: 800; color: var(--navy); margin-bottom: 12px; }
.sh-body { font-size: 14px; color: var(--text2); line-height: 1.65; }
.sh-body p { margin-bottom: 10px; }
.sh-body strong { color: var(--text); }
.sh-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 18px; }
.sh-ref-chip {
  display: inline-flex; align-items: center;
  background: var(--navy-light); color: var(--navy);
  font-size: 11px; font-weight: 700;
  padding: 4px 10px; border-radius: 20px; margin: 2px 4px 2px 0;
}

/* â•â•â• HIDDEN â•â•â• */
.hidden { display: none !important; }

/* â•â•â• ERR ROW â•â•â• */
.row.err { background: var(--red-light); }
.row.err .row-label { color: var(--red); }

/* â•â•â• SECTION SEPARATOR â•â•â• */
.view-section-title {
  font-size: 11px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .7px;
  margin: 18px 4px 8px; padding: 0 4px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHECKLIST TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.op-selector {
  background: var(--surface); border-radius: var(--radius-lg);
  overflow: hidden; border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm); margin-bottom: 12px;
}
.op-selector-header {
  padding: 14px 16px; border-bottom: 1px solid var(--border2);
}
.op-selector-header h3 { font-size: 14px; font-weight: 700; color: var(--navy); }
.op-selector-header p { font-size: 12px; color: var(--text3); margin-top: 2px; }
.op-pills {
  display: flex; gap: 8px; padding: 12px 16px; flex-wrap: wrap;
}
.op-pill {
  padding: 9px 18px; border-radius: 22px;
  font-size: 13px; font-weight: 700; cursor: pointer; border: none;
  background: var(--surface2); color: var(--text3);
  border: 1.5px solid var(--border);
  transition: all .15s;
  font-family: -apple-system, sans-serif;
}
.op-pill.selected {
  background: var(--navy); color: #fff; border-color: var(--navy);
  box-shadow: 0 4px 12px rgba(0,30,98,.25);
}
.op-pill:active { transform: scale(.95); }
.material-pills { display: flex; gap: 8px; padding: 0 16px 12px; }
.mat-pill {
  flex: 1; padding: 9px; border-radius: 10px;
  font-size: 12px; font-weight: 700; cursor: pointer; border: none;
  background: var(--surface2); color: var(--text3);
  border: 1.5px solid var(--border);
  transition: all .15s; text-align: center;
  font-family: -apple-system, sans-serif;
}
.mat-pill.selected { background: var(--teal); color: #fff; border-color: var(--teal); }
.mat-pill:active { transform: scale(.95); }

.checklist-phase {
  background: var(--surface); border-radius: var(--radius-lg);
  overflow: hidden; border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm); margin-bottom: 12px;
}
.phase-header {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 16px; cursor: pointer;
  user-select: none; -webkit-user-select: none;
  border-bottom: 1px solid var(--border2);
}
.phase-letter {
  width: 30px; height: 30px; border-radius: 9px;
  background: var(--navy); color: #fff;
  font-size: 14px; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.phase-title { flex: 1; }
.phase-title h4 { font-size: 13px; font-weight: 700; color: var(--navy); }
.phase-title p  { font-size: 11px; color: var(--text3); margin-top: 1px; }
.phase-progress {
  font-size: 11px; font-weight: 700; color: var(--text3);
  background: var(--surface2); padding: 3px 9px; border-radius: 14px;
  border: 1px solid var(--border);
}
.phase-progress.complete { background: var(--green-light); color: var(--green); border-color: var(--green-light); }
.phase-chevron {
  font-size: 12px; color: var(--text3); transition: transform .2s;
}
.phase-header.open .phase-chevron { transform: rotate(90deg); }
.phase-body { display: none; }
.phase-body.open { display: block; }

/* CHECKLIST ITEM */
.cl-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 16px; border-bottom: 1px solid var(--border2);
  cursor: pointer; user-select: none; -webkit-user-select: none;
  transition: background .1s;
}
.cl-item:last-child { border-bottom: none; }
.cl-item:active { background: var(--surface2); }
.cl-check {
  width: 24px; height: 24px; border-radius: 50%;
  border: 2px solid var(--border); background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: 1px;
  transition: all .2s cubic-bezier(.4,0,.2,1);
}
.cl-check svg { opacity: 0; transition: opacity .15s; }
.cl-item.checked .cl-check {
  background: var(--navy); border-color: var(--navy);
  box-shadow: 0 0 0 3px var(--navy-light);
}
.cl-item.checked .cl-check svg { opacity: 1; }
.cl-item.checked .cl-text { text-decoration: line-through; color: var(--text3); }
.cl-content { flex: 1; min-width: 0; }
.cl-text { font-size: 14px; font-weight: 600; color: var(--text); line-height: 1.35; }
.cl-sub  { font-size: 12px; color: var(--text3); margin-top: 3px; }
.cl-tag  {
  display: inline-flex; align-items: center;
  font-size: 10px; font-weight: 700;
  padding: 2px 8px; border-radius: 6px; margin-top: 5px; margin-right: 4px;
}
.tag-prereq { background: var(--amber-light); color: var(--amber); }
.tag-naf    { background: var(--red-light); color: var(--red); }
.tag-urgent { background: var(--red); color: #fff; }
.tag-ref    { background: var(--navy-light); color: var(--navy); }

/* Subsection */
.cl-subsec {
  font-size: 11px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .5px;
  padding: 8px 16px 6px 52px;
  background: var(--surface2);
  border-bottom: 1px solid var(--border2);
}

/* Checklist global actions */
.cl-actions {
  display: flex; gap: 8px; margin-bottom: 12px;
}
.cl-action-btn {
  flex: 1; padding: 11px; border-radius: var(--radius-md);
  font-size: 13px; font-weight: 700; cursor: pointer; border: none;
  font-family: -apple-system, sans-serif; transition: filter .15s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.cl-action-btn:active { filter: brightness(.88); }
.cl-btn-reset { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.cl-btn-complete { background: var(--navy); color: #fff; }

/* Empty checklist */
.cl-empty {
  text-align: center; padding: 48px 24px; color: var(--text3);
}
.cl-empty-ico { font-size: 48px; margin-bottom: 12px; }
.cl-empty p { font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--text2); }
.cl-empty small { font-size: 13px; line-height: 1.5; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ã‰TUDE DE LIGNE TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ligne-section-title {
  font-size: 11px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .6px;
  padding: 4px 4px 8px;
}
.ligne-card {
  background: var(--surface); border-radius: var(--radius-lg);
  overflow: hidden; border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm); margin-bottom: 12px;
}
.ligne-card-header {
  display: flex; align-items: center; gap: 10px;
  padding: 13px 16px; background: var(--navy); color: #fff;
  cursor: pointer; user-select: none;
}
.ligne-card-header h3 { font-size: 13px; font-weight: 700; flex: 1; }
.ligne-card-header .lc-ico { font-size: 18px; }
.ligne-card-header .lc-chev { font-size: 12px; opacity: .7; transition: transform .2s; }
.ligne-card-header.open .lc-chev { transform: rotate(90deg); }
.ligne-card-body { display: none; }
.ligne-card-body.open { display: block; }

.menace-row {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 13px 16px; border-bottom: 1px solid var(--border2);
}
.menace-row:last-child { border-bottom: none; }
.menace-ico { font-size: 20px; flex-shrink: 0; margin-top: 2px; }
.menace-content { flex: 1; }
.menace-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 3px; }
.menace-sub { font-size: 12px; color: var(--text2); line-height: 1.5; }
.menace-tag {
  display: inline-flex; align-items: center;
  font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 6px;
  margin-top: 4px; margin-right: 4px;
}
.mtag-danger { background: var(--red-light); color: var(--red); }
.mtag-warn   { background: var(--amber-light); color: var(--amber); }
.mtag-info   { background: var(--blue-light); color: var(--blue); }
.mtag-ok     { background: var(--green-light); color: var(--green); }

.vitesse-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 8px; padding: 12px 16px;
}
.vitesse-cell {
  border-radius: var(--radius-sm); padding: 10px 12px;
  font-size: 12px; font-weight: 700;
}
.vitesse-cell .v-num { font-size: 20px; font-weight: 800; letter-spacing: -1px; }
.vitesse-cell .v-ctx { font-size: 11px; font-weight: 600; margin-top: 2px; color: inherit; opacity: .8; }
.v-30 { background: #FFE8F0; color: #C8102E; }
.v-50 { background: #FFF5DC; color: #C97B00; }
.v-60 { background: #E6F5EC; color: #1A7A3C; }
.v-70 { background: #E5F0FF; color: #006BDE; }

.methodologie-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 11px 16px; border-bottom: 1px solid var(--border2);
}
.methodologie-item:last-child { border-bottom: none; }
.meth-dist {
  background: var(--navy); color: #fff;
  font-size: 12px; font-weight: 800; padding: 4px 10px; border-radius: 8px;
  flex-shrink: 0; letter-spacing: .3px; min-width: 60px; text-align: center;
}
.meth-rule { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }

.voie-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.voie-table th {
  background: var(--navy); color: #fff;
  padding: 8px 10px; text-align: left; font-size: 11px; font-weight: 700;
}
.voie-table td { padding: 7px 10px; border-bottom: 1px solid var(--border2); }
.voie-table tr:last-child td { border-bottom: none; }
.voie-table tr:nth-child(even) td { background: var(--surface2); }

.em-detect-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--navy-light); color: var(--navy);
  font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px;
  margin-top: 4px;
}

.poste-section-title {
  font-size: 11px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .6px;
  padding: 4px 4px 8px;
}
.poste-card {
  background: var(--surface); border-radius: var(--radius-lg);
  overflow: hidden; border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm); margin-bottom: 10px;
}
.poste-row {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px; border-bottom: 1px solid var(--border2);
  cursor: pointer;
  transition: background .1s;
}
.poste-row:last-child { border-bottom: none; }
.poste-row:active { background: var(--surface2); }
.poste-ico {
  width: 40px; height: 40px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.poste-info { flex: 1; min-width: 0; }
.poste-name { font-size: 14px; font-weight: 700; color: var(--text); }
.poste-details { font-size: 12px; color: var(--text3); margin-top: 2px; }
.poste-badge {
  display: flex; flex-direction: column; align-items: flex-end; gap: 3px; flex-shrink: 0;
}
.poste-type {
  font-size: 10px; font-weight: 700; padding: 3px 9px; border-radius: 12px;
}
.poste-type.sld { background: var(--teal-light); color: var(--teal); }
.poste-type.pad { background: var(--navy-light); color: var(--navy); }
.poste-type.av  { background: var(--amber-light); color: var(--amber); }

.ref-card {
  background: var(--surface); border-radius: var(--radius-lg);
  padding: 16px; border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm); margin-bottom: 10px;
}
.ref-card h4 { font-size: 13px; font-weight: 800; color: var(--navy); margin-bottom: 8px; letter-spacing: .3px; }
.ref-article {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 10px 0; border-bottom: 1px solid var(--border2);
}
.ref-article:last-child { border-bottom: none; }
.ref-code {
  background: var(--navy); color: #fff;
  font-size: 11px; font-weight: 800; padding: 3px 8px; border-radius: 6px;
  flex-shrink: 0; letter-spacing: .3px;
}
.ref-desc { font-size: 12px; color: var(--text2); line-height: 1.45; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hist-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.hist-header h2 { font-size: 20px; font-weight: 800; color: var(--navy); }
.hist-count {
  background: var(--navy); color: #fff;
  font-size: 11px; font-weight: 700;
  padding: 4px 12px; border-radius: 20px;
}
.export-btn {
  width: 100%; background: var(--teal); color: #fff;
  border: none; border-radius: var(--radius-md); padding: 14px;
  font-size: 14px; font-weight: 700; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  font-family: -apple-system, sans-serif;
  margin-bottom: 14px;
  box-shadow: 0 4px 12px rgba(0,95,115,.25);
  transition: filter .15s;
}
.export-btn:active { filter: brightness(.88); }
.hist-card {
  background: var(--surface); border-radius: var(--radius-lg);
  overflow: hidden; border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm); margin-bottom: 12px;
}
.hist-card-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; background: var(--navy); color: #fff;
}
.hist-train { font-size: 15px; font-weight: 800; font-variant-numeric: tabular-nums; }
.hist-date  { font-size: 11px; opacity: .6; }
.hist-body  { padding: 12px 16px; }
.hist-grid  { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 14px; }
.hist-ci label { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; display: block; margin-bottom: 2px; }
.hist-ci span  { font-size: 12px; font-weight: 600; color: var(--text); }
.hist-obs { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border2); font-size: 12px; color: var(--text3); font-style: italic; line-height: 1.45; }
.badge-ok { background: var(--green-light); color: var(--green); font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 12px; display: inline-block; }
.badge-ko { background: var(--red-light); color: var(--red); font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 12px; display: inline-block; }
.hist-empty { text-align: center; padding: 60px 24px; color: var(--text3); }
.hist-empty .ei { font-size: 52px; margin-bottom: 12px; }
.hist-empty p { font-size: 15px; font-weight: 600; color: var(--text2); }
</style>
</head>
<body>
<div id="APP">

<!-- â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â• -->
<div id="HDR">
  <div class="hdr-content">
    <div class="hdr-badge">ğŸš„</div>
    <div class="hdr-title">
      <h1>Prise de Service</h1>
      <p>FMN Â· Paris-Est Â· Conducteur SNCF</p>
    </div>
    <div class="hdr-actions">
      <button class="icon-btn" onclick="showHelp()" title="Aide &amp; RÃ©fÃ©rentiel">â„¹ï¸</button>
    </div>
  </div>
  <div id="PROGRESS-WRAP">
    <div class="progress-bar-bg"><div class="progress-bar-fill" id="PROG-BAR"></div></div>
    <div class="progress-pct" id="PROG-PCT">0%</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â• -->
<div id="TABS">
  <button class="tab on" id="TAB-form"      onclick="goTab('form')">
    <span class="tab-ico">ğŸ“‹</span><span class="tab-lbl">Formulaire</span>
  </button>
  <button class="tab"    id="TAB-checklist" onclick="goTab('checklist')">
    <span class="tab-ico">âœ…</span><span class="tab-lbl">Checklist</span>
  </button>
  <button class="tab"    id="TAB-ligne"     onclick="goTab('ligne')">
    <span class="tab-ico">ğŸ—ºï¸</span><span class="tab-lbl">Ligne</span>
  </button>
  <button class="tab"    id="TAB-postes"    onclick="goTab('postes')">
    <span class="tab-ico">ğŸ“</span><span class="tab-lbl">Postes</span>
  </button>
  <button class="tab"    id="TAB-hist"      onclick="goTab('hist')">
    <span class="tab-ico">ğŸ“Š</span><span class="tab-lbl">Historique</span>
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• VIEWS â•â•â•â•â•â•â•â•â•â• -->
<div id="VIEWS">

  <!-- â•â•â•â•â•â•â•â• FORMULAIRE â•â•â•â•â•â•â•â• -->
  <div id="V-form" class="view on">

    <!-- 1. IDENTIFICATION -->
    <div class="view-section-title">Identification</div>
    <div class="section">
      <div class="section-header">
        <div class="section-num">1</div>
        <div class="section-title">Identification</div>
      </div>
      <div class="row" id="R-date">
        <div class="row-left"><div class="dot" id="d-date"></div>
          <div><div class="row-label">Date</div></div>
        </div>
        <div class="row-right"><input type="date" id="F-date" onchange="onDate()"></div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-jour"></div><div class="row-label">NÂ° JournÃ©e</div></div>
        <div class="row-right"><input type="text" id="F-jour" placeholder="ex: I130" maxlength="12" oninput="dotTxt('d-jour',this)"></div>
      </div>
      <div class="row" id="R-train">
        <div class="row-left"><div class="dot" id="d-train"></div><div class="row-label">NÂ° Train</div></div>
        <div class="row-right"><input type="text" id="F-train" placeholder="ex: 795971" maxlength="12" oninput="dotTxt('d-train',this)"></div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-indice"></div><div class="row-label">Indice</div></div>
        <div class="row-right"><input type="text" id="F-indice" placeholder="ex: 16" maxlength="8" oninput="dotTxt('d-indice',this)"></div>
      </div>
    </div>

    <!-- 2. OPÃ‰RATION & COMPOSITION -->
    <div class="view-section-title">Composition</div>
    <div class="section">
      <div class="section-header">
        <div class="section-num">2</div>
        <div class="section-title">OpÃ©ration &amp; Composition</div>
      </div>
      <div class="row" id="R-op">
        <div class="row-left"><div class="dot" id="d-op"></div>
          <div>
            <div class="row-label">OpÃ©ration</div>
            <div class="row-sub">PC Â· RS Â· RSr Â· MS</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-op" onchange="dotSel('d-op',this,'any'); syncOpChecklist()">
            <option value="">Choisirâ€¦</option>
            <option>PC</option><option>RS</option><option>RSr</option><option>MS</option>
          </select>
        </div>
      </div>
      <div class="row" id="R-mat">
        <div class="row-left"><div class="dot" id="d-mat"></div>
          <div>
            <div class="row-label">MatÃ©riel</div>
            <div class="row-sub">NAT Â· Z2N</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-mat" onchange="dotSel('d-mat',this,'any'); syncOpChecklist()">
            <option value="">Choisirâ€¦</option>
            <option>NAT</option><option>Z2N</option>
          </select>
        </div>
      </div>
      <div class="row" id="R-compo">
        <div class="row-left"><div class="dot" id="d-compo"></div>
          <div>
            <div class="row-label">Composition</div>
            <div class="row-sub">US = 1 EM Â· UM = 2 EM</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-compo" onchange="onCompo(this)">
            <option value="">Choisirâ€¦</option>
            <option>US</option><option>UM</option>
          </select>
        </div>
      </div>
      <div class="row" id="R-nem1">
        <div class="row-left"><div class="dot" id="d-nem1"></div>
          <div>
            <div class="row-label" id="LBL-nem1">NÂ° EM</div>
            <div class="row-sub"  id="SUB-nem1">Choisir la composition d'abord</div>
            <div id="EM1-badge" style="display:none"></div>
          </div>
        </div>
        <div class="row-right"><input type="text" id="F-nem1" placeholder="NÂ° EM cÃ´tÃ© Paris" maxlength="12" oninput="dotTxt('d-nem1',this); detectEM(this,'EM1-badge')"></div>
      </div>
      <div class="row hidden" id="R-nem2">
        <div class="row-left"><div class="dot" id="d-nem2"></div>
          <div>
            <div class="row-label">NÂ° EM cÃ´tÃ© Province</div>
            <div class="row-sub">UM â€” 2áµ‰ Engin Moteur</div>
            <div id="EM2-badge" style="display:none"></div>
          </div>
        </div>
        <div class="row-right"><input type="text" id="F-nem2" placeholder="NÂ° EM Province" maxlength="12" oninput="dotTxt('d-nem2',this); detectEM(this,'EM2-badge')"></div>
      </div>
    </div>

    <!-- 3. HORAIRES & LIEUX -->
    <div class="view-section-title">Horaires &amp; Lieux</div>
    <div class="section">
      <div class="section-header">
        <div class="section-num">3</div>
        <div class="section-title">Horaires &amp; Lieux</div>
      </div>

      <div class="row" id="R-dep">
        <div class="row-left"><div class="dot" id="d-dep"></div>
          <div>
            <div class="row-label">DÃ©part PrÃ©vu</div>
            <div class="row-sub">Date + heure â†’ calcule HD</div>
          </div>
        </div>
        <div class="row-right" style="flex-direction:column;align-items:flex-end;gap:6px">
          <input type="date" id="F-dep-d" onchange="onDep()">
          <input type="time" id="F-dep-h" onchange="onDep()" step="60">
        </div>
      </div>

      <div class="row" id="R-ldep">
        <div class="row-left"><div class="dot" id="d-ldep"></div><div class="row-label">Lieu de DÃ©part</div></div>
        <div class="row-right">
          <select id="F-ldep" onchange="dotSel('d-ldep',this,'any')">
            <option value="">Choisirâ€¦</option>
            <option>PE</option><option>PAN Z</option><option>PAN TR</option><option>PAN FV</option><option>NSY FB</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="row-left"><div class="dot" id="d-arr"></div>
          <div>
            <div class="row-label">ArrivÃ©e PrÃ©vue</div>
            <div class="row-sub">Date + heure</div>
          </div>
        </div>
        <div class="row-right" style="flex-direction:column;align-items:flex-end;gap:6px">
          <input type="date" id="F-arr-d" onchange="dotPair('d-arr','F-arr-d','F-arr-h')">
          <input type="time" id="F-arr-h" onchange="dotPair('d-arr','F-arr-d','F-arr-h')" step="60">
        </div>
      </div>

      <div class="row">
        <div class="row-left"><div class="dot" id="d-larr"></div><div class="row-label">Lieu d'ArrivÃ©e</div></div>
        <div class="row-right">
          <select id="F-larr" onchange="dotSel('d-larr',this,'any')">
            <option value="">Choisirâ€¦</option>
            <option>PE</option><option>PAN Z</option><option>PAN TR</option><option>PAN FV</option><option>NSY FB</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="row-left"><div class="dot" id="d-hd"></div>
          <div>
            <div class="row-label">HD â€” Heure de DÃ©part</div>
            <div class="row-sub" id="HD-sub">Auto depuis DÃ©part PrÃ©vu</div>
          </div>
        </div>
        <div class="row-right"><div class="hd-display" id="HD-box">--:--</div></div>
      </div>
    </div>

    <!-- 4. PPE SOL -->
    <div class="view-section-title">Protection &amp; SÃ©curitÃ©</div>
    <div class="section">
      <div class="section-header">
        <div class="section-num">4</div>
        <div class="section-title">PPE Sol</div>
      </div>
      <div class="row" id="R-ppesol">
        <div class="row-left"><div class="dot" id="d-ppesol"></div><div class="row-label">PPE Sol</div></div>
        <div class="row-right">
          <select id="F-ppesol" onchange="dotSel('d-ppesol',this,'okko'); checkPPESol()">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="alert danger hidden" id="AL-eas">
        âš ï¸ PPE Sol KO â€” EAS hors service ! Signaler immÃ©diatement au PC. Art. E 24.03 applicable.
      </div>
    </div>

    <!-- 5. PPE BORD -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">5</div>
        <div class="section-title">PPE Bord</div>
      </div>
      <div class="row" id="R-sigav">
        <div class="row-left"><div class="dot" id="d-sigav"></div>
          <div>
            <div class="row-label">Signalisation d'avant</div>
            <div class="row-sub">Art. D 21.01 â€” vÃ©rification obligatoire</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-sigav" onchange="dotSel('d-sigav',this,'okko'); checkPPEBord()">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="subsec-label">Dispositifs de sÃ©curitÃ©</div>
      <div class="kvb-grid">
        <div class="kvb-item"><label>VA</label>
          <select id="F-va" onchange="dotSel('',this,'okko'); checkPPEBord()">
            <option value="">â€”</option><option>OK</option><option>KO</option>
          </select>
        </div>
        <div class="kvb-item"><label>KVB</label>
          <select id="F-kvb" onchange="dotSel('',this,'okko'); checkPPEBord()">
            <option value="">â€”</option><option>OK</option><option>KO</option>
          </select>
        </div>
        <div class="kvb-item"><label>RST</label>
          <select id="F-rst" onchange="dotSel('',this,'okko'); checkPPEBord()">
            <option value="">â€”</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="row" id="R-eas">
        <div class="row-left"><div class="dot" id="d-eas"></div>
          <div>
            <div class="row-label">EAS Bord</div>
            <div class="row-sub">Essai Automatique de SÃ©curitÃ©</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-eas" onchange="dotSel('d-eas',this,'okko'); checkPPEBord()">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="status-banner" id="BAN-ppe">
        <div class="status-dot"></div>
        <span id="BAN-ppe-t">PPE Bord â€” En attente de saisie</span>
      </div>
    </div>

    <!-- 6. SERVICE TRAIN D 13.03 -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">6</div>
        <div class="section-title">ST â€” Service Train</div>
        <span class="section-badge" style="background:var(--navy-light);color:var(--navy);font-size:10px;font-weight:700;padding:3px 8px;border-radius:12px">Art. D 13.03</span>
      </div>
      <div class="row" id="R-portes">
        <div class="row-left"><div class="dot" id="d-portes"></div><div class="row-label">Portes</div></div>
        <div class="row-right">
          <select id="F-portes" onchange="dotSel('d-portes',this,'okko'); checkST()">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="row" id="R-ordres">
        <div class="row-left"><div class="dot" id="d-ordres"></div>
          <div>
            <div class="row-label">Remise d'ordres</div>
            <div class="row-sub">Bulletins &amp; ordres concernant le train â€” Art. D 25.02</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-ordres" onchange="dotSel('d-ordres',this,'okko'); checkST()">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="row" id="R-annonce">
        <div class="row-left"><div class="dot" id="d-annonce"></div><div class="row-label">Annonce sonore</div></div>
        <div class="row-right">
          <select id="F-annonce" onchange="dotSel('d-annonce',this,'okko'); checkST()">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="status-banner" id="BAN-st">
        <div class="status-dot"></div>
        <span id="BAN-st-t">Service Train â€” En attente de saisie</span>
      </div>
    </div>

    <!-- 7. RELÃˆVE D 25.02 -->
    <div class="view-section-title">RelÃ¨ve de Conducteur</div>
    <div class="section">
      <div class="section-header">
        <div class="section-num">7</div>
        <div class="section-title">RelÃ¨ve â€” Art. D 25.02</div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-gsmgfu"></div>
          <div>
            <div class="row-label">GSM-GFU initialisÃ©</div>
            <div class="row-sub">Au plus tard Ã  la gare origine du 1er train</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-gsmgfu" onchange="dotSel('d-gsmgfu',this,'okko')">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-carnbord"></div>
          <div>
            <div class="row-label">Carnet de Bord consultÃ©</div>
            <div class="row-sub">Art. E 23.07 â€” Ã  la premiÃ¨re occasion favorable</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-carnbord" onchange="dotSel('d-carnbord',this,'okko')">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-surcharge"></div>
          <div>
            <div class="row-label">SURCHARGE commandÃ©e</div>
            <div class="row-sub">Lors du desserrage â€” Art. D 25.02</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-surcharge" onchange="dotSel('d-surcharge',this,'okko')">
            <option value="">Choisirâ€¦</option><option>OK</option><option>N/A</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-odiceo"></div>
          <div>
            <div class="row-label">ODICEO</div>
            <div class="row-sub">Art. E 41.01 â€” activation &amp; ordre traitÃ©</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-odiceo" onchange="dotSel('d-odiceo',this,'any'); checkOdiceo()">
            <option value="">Choisirâ€¦</option>
            <option>ActivÃ©</option><option>Non Ã©quipÃ©</option><option>Ordre en cours</option>
          </select>
        </div>
      </div>
      <div class="alert info hidden" id="AL-odiceo">
        ğŸ“± Ordre ODICEO en cours â€” Aviser le SGC. S'activer sur SIRIUS ou smartphone professionnel. Traiter l'ordre. Art. E 41.01.
      </div>
    </div>

    <!-- 8. AuM -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">8</div>
        <div class="section-title">AuM â€” Autorisation de Mouvement</div>
        <span class="section-badge" style="background:var(--navy-light);color:var(--navy);font-size:10px;font-weight:700;padding:3px 8px;border-radius:12px">Art. D 13.01</span>
      </div>
      <div class="row" id="R-aum">
        <div class="row-left"><div class="dot" id="d-aum"></div><div class="row-label">Type d'AuM</div></div>
        <div class="row-right">
          <select id="F-aum" onchange="dotSel('d-aum',this,'any')">
            <option value="">Choisirâ€¦</option>
            <option>AuM Signal</option><option>AuM Lili</option><option>AuM Verbale</option><option>AuM Ã‰crite</option><option>AuM Ã  Main</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 9. SIRIUS & VAE -->
    <div class="view-section-title">SIRIUS &amp; Vigilance</div>
    <div class="section">
      <div class="section-header">
        <div class="section-num">9</div>
        <div class="section-title">SIRIUS &amp; VAE</div>
      </div>
      <div class="row" id="R-smc">
        <div class="row-left"><div class="dot" id="d-smc"></div><div class="row-label">SIRIUS Mode Conduite</div></div>
        <div class="row-right">
          <select id="F-smc" onchange="dotSel('d-smc',this,'ouinon')">
            <option value="">Choisirâ€¦</option><option>Oui</option><option>Non</option>
          </select>
        </div>
      </div>
      <div class="row" id="R-sad">
        <div class="row-left"><div class="dot" id="d-sad"></div>
          <div>
            <div class="row-label">SIRIUS AdhÃ©rence DÃ©gradÃ©e</div>
            <div class="row-sub">Art. D 24.04</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-sad" onchange="dotSel('d-sad',this,'ouinon'); checkSiriusAD()">
            <option value="">Choisirâ€¦</option><option>Oui</option><option>Non</option>
          </select>
        </div>
      </div>
      <div class="alert warn hidden" id="AL-sirius">
        âš ï¸ AdhÃ©rence DÃ©gradÃ©e â€” Mesures FMN applicables. RÃ©duire vitesse. Signaler au rÃ©gulateur. Art. D 24.04.
      </div>
      <div class="row" id="R-vae">
        <div class="row-left"><div class="dot" id="d-vae"></div>
          <div>
            <div class="row-label">VAE</div>
            <div class="row-sub" id="VAE-ts-txt">Non horodatÃ©e</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-vae" onchange="dotSel('d-vae',this,'ouinon'); onVAE()">
            <option value="">Choisirâ€¦</option><option>Oui</option><option>Non</option>
          </select>
        </div>
      </div>
      <div class="ts-block hidden" id="VAE-ts-block">
        <div class="ts-lbl">â± Horodatage VAE <span style="font-weight:400;color:var(--text3);text-transform:none">(optionnel)</span></div>
        <div class="ts-row">
          <button class="btn-sm btn-navy-sm" onclick="tsAuto('VAE')">â± Auto</button>
          <input type="date" id="F-vae-d" style="min-width:135px" onchange="tsPreview('VAE')">
          <input type="time" id="F-vae-h" style="min-width:85px"  onchange="tsPreview('VAE')" step="60">
          <button class="btn-sm btn-green-sm" onclick="tsApply('VAE')">âœ“ Appliquer</button>
        </div>
        <div class="ts-hint" id="VAE-ts-hint">Saisir l'heure exacte de la VAE</div>
      </div>
      <div class="alert teal hidden" id="AL-oae">
        âœ… OAE applicable â€” Ordre d'ArrÃªt d'Exception. Notifier l'agent-circulation.
      </div>
      <!-- VA en marche D 25.02 -->
      <div class="row">
        <div class="row-left"><div class="dot" id="d-vamarche"></div>
          <div>
            <div class="row-label">Essai VA en marche</div>
            <div class="row-sub">Au dÃ©marrage â€” Art. D 25.02 obligatoire</div>
          </div>
        </div>
        <div class="row-right">
          <select id="F-vamarche" onchange="dotSel('d-vamarche',this,'okko')">
            <option value="">Choisirâ€¦</option><option>OK</option><option>KO</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 10. ARRIVÃ‰E EFFECTIVE -->
    <div class="view-section-title">Fin de Service</div>
    <div class="section">
      <div class="section-header">
        <div class="section-num">10</div>
        <div class="section-title">ArrivÃ©e Effective &amp; Observations</div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-arreff"></div>
          <div>
            <div class="row-label">ArrivÃ©e Effective</div>
            <div class="row-sub" id="ARR-ts-txt">Non horodatÃ©e</div>
          </div>
        </div>
        <div class="row-right"><button class="btn-sm btn-navy-sm" onclick="tsAuto('ARR')">â± Auto</button></div>
      </div>
      <div class="ts-block">
        <div class="ts-lbl">âœï¸ Saisie manuelle</div>
        <div class="ts-row">
          <input type="date" id="F-arr-ts-d" style="min-width:135px" onchange="tsPreview('ARR')">
          <input type="time" id="F-arr-ts-h" style="min-width:85px"  onchange="tsPreview('ARR')" step="60">
          <button class="btn-sm btn-green-sm" onclick="tsApply('ARR')">âœ“ Appliquer</button>
        </div>
        <div class="ts-hint" id="ARR-ts-hint">Heure d'arrivÃ©e effective (optionnel)</div>
      </div>
      <div class="row row-full">
        <div class="row-label">ğŸ“ Observations</div>
        <textarea id="F-obs" placeholder="Consigner tout incident, anomalie ou renseignement Ã  transmettreâ€¦"></textarea>
      </div>
    </div>

    <!-- 11. REX & DOC ADC -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">11</div>
        <div class="section-title">REX &amp; Document ADC</div>
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-rex"></div><div class="row-label">REX</div></div>
        <div class="row-right">
          <select id="F-rex" onchange="dotSel('d-rex',this,'any'); checkRex()">
            <option value="">Choisirâ€¦</option><option>Oui</option><option>Non</option>
          </select>
        </div>
      </div>
      <div class="alert info hidden" id="AL-rex">
        ğŸ“ REX activÃ© â€” Joindre la piÃ¨ce justificative au rapport.
      </div>
      <div class="row">
        <div class="row-left"><div class="dot" id="d-docadc"></div><div class="row-label">Document ADC Ã©marginÃ©</div></div>
        <div class="row-right">
          <select id="F-docadc" onchange="dotSel('d-docadc',this,'any'); checkDocADC()">
            <option value="">Choisirâ€¦</option><option>Oui</option><option>Non</option>
          </select>
        </div>
      </div>
      <div class="row hidden" id="R-docnum">
        <div class="row-left"><div class="dot" id="d-docnum"></div><div class="row-label">NÂ° Document Ã©marginÃ©</div></div>
        <div class="row-right"><input type="text" id="F-docnum" placeholder="NumÃ©ro" maxlength="20" oninput="dotTxt('d-docnum',this)"></div>
      </div>
    </div>

    <div style="height:8px"></div>

  </div><!-- /V-form -->

  <!-- â•â•â•â•â•â•â•â• CHECKLIST â•â•â•â•â•â•â•â• -->
  <div id="V-checklist" class="view">

    <!-- SÃ©lecteur OpÃ©ration / MatÃ©riel -->
    <div class="op-selector">
      <div class="op-selector-header">
        <h3>ğŸ”§ ProcÃ©dure Technique</h3>
        <p>SÃ©lectionner l'opÃ©ration et le matÃ©riel</p>
      </div>
      <div class="op-pills">
        <button class="op-pill" id="CL-PC"  onclick="selectCLOp('PC')">PC</button>
        <button class="op-pill" id="CL-RS"  onclick="selectCLOp('RS')">RS</button>
        <button class="op-pill" id="CL-RSr" onclick="selectCLOp('RSr')">RSr</button>
        <button class="op-pill" id="CL-MS"  onclick="selectCLOp('MS')">MS</button>
      </div>
      <div class="material-pills">
        <button class="mat-pill" id="MAT-NAT" onclick="selectMat('NAT')">NAT</button>
        <button class="mat-pill" id="MAT-Z2N" onclick="selectMat('Z2N')">Z2N</button>
      </div>
    </div>

    <!-- Actions checklist -->
    <div class="cl-actions" id="CL-ACTIONS" style="display:none">
      <button class="cl-action-btn cl-btn-reset"    onclick="resetChecklist()">ğŸ”„ RÃ©initialiser</button>
      <button class="cl-action-btn cl-btn-complete" onclick="completeAll()">âœ“ Tout cocher</button>
    </div>

    <!-- Checklist content -->
    <div id="CL-CONTENT">
      <div class="cl-empty">
        <div class="cl-empty-ico">ğŸ“‹</div>
        <p>Aucune opÃ©ration sÃ©lectionnÃ©e</p>
        <small>Choisir l'opÃ©ration et le type de matÃ©riel<br>pour afficher la procÃ©dure technique.</small>
      </div>
    </div>

  </div><!-- /V-checklist -->

  <!-- â•â•â•â•â•â•â•â• Ã‰TUDE DE LIGNE â•â•â•â•â•â•â•â• -->
  <div id="V-ligne" class="view">

    <div class="ligne-section-title">Vitesses â€” Voies Lentes</div>

    <!-- Carte Sens Impair PE â†’ NSY -->
    <div class="ligne-card">
      <div class="ligne-card-header" onclick="toggleLigne(this)">
        <span class="lc-ico">â†’</span>
        <h3>Sens Impair â€” Paris-Est â†’ NSY</h3>
        <span class="lc-chev">â€º</span>
      </div>
      <div class="ligne-card-body">
        <div class="vitesse-grid">
          <div class="vitesse-cell v-30"><div class="v-num">30</div><div class="v-ctx">Voies VS courtes / zones embranchement</div></div>
          <div class="vitesse-cell v-50"><div class="v-num">50</div><div class="v-ctx">VS standard â€” voies K, M, L, 2Bis</div></div>
          <div class="vitesse-cell v-60"><div class="v-num">60</div><div class="v-ctx">Pont du dÃ©partement â€” 1V/2V</div></div>
          <div class="vitesse-cell v-70"><div class="v-num">70</div><div class="v-ctx">PAN Z â†’ NSY voies L / M</div></div>
        </div>
        <div style="padding:0 16px 12px">
          <div class="alert info" style="margin:0 0 10px">ğŸ“Œ Voies 1 et 2B1 = <strong>Mal dirigÃ© âš ï¸</strong> en sens impair depuis Paris-Est</div>
          <div class="alert warn" style="margin:0 0 10px">ğŸ”µ C.2523 : Dernier carat si dirigÃ© vers NSY sur voie 1bis â†’ Solliciter l'AC</div>
          <div class="alert info" style="margin:0 0 0">ğŸ”µ C.2245 / C.2243 / C.2241 donnent directions NSY âœ… G âœ… OC âŒ</div>
        </div>
        <!-- Tableau voies Pantin Zone -->
        <div style="padding:0 16px 12px">
          <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Longueurs voies PAN Z entre TLC</div>
          <table class="voie-table">
            <tr><th>Voie</th><th>Longueur (m)</th><th>Voie</th><th>Longueur (m)</th></tr>
            <tr><td>13</td><td>262</td><td>17</td><td>296</td></tr>
            <tr><td>19</td><td>218</td><td>21</td><td>218</td></tr>
            <tr><td>23</td><td>257</td><td>25</td><td>221</td></tr>
            <tr><td>27</td><td>249</td><td>29</td><td>276</td></tr>
            <tr><td>31</td><td>249</td><td>33</td><td>249</td></tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Carte Sens Pair NSY â†’ PE -->
    <div class="ligne-card">
      <div class="ligne-card-header" onclick="toggleLigne(this)">
        <span class="lc-ico">â†</span>
        <h3>Sens Pair â€” NSY â†’ Paris-Est</h3>
        <span class="lc-chev">â€º</span>
      </div>
      <div class="ligne-card-body">
        <div class="vitesse-grid">
          <div class="vitesse-cell v-30"><div class="v-num">30</div><div class="v-ctx">Zones embranchement PE</div></div>
          <div class="vitesse-cell v-50"><div class="v-num">50</div><div class="v-ctx">VS standard â€” voies K, L, M</div></div>
          <div class="vitesse-cell v-60"><div class="v-num">60</div><div class="v-ctx">Pont du dÃ©partement â€” 1V/2V</div></div>
          <div class="vitesse-cell v-70"><div class="v-num">70</div><div class="v-ctx">NSY â†’ PAN voies L / M</div></div>
        </div>
        <div style="padding:0 16px 12px">
          <div class="alert warn" style="margin:0 0 10px">âš ï¸ KM 2,3 â€” C.2236 nÃ©cessite basculement avant accÃ¨s voie</div>
          <div class="alert info" style="margin:0 0 10px">ğŸ”µ C.270 : Si RR30 â†’ Impossible d'accÃ©der Ã  Pantin Zone</div>
          <div class="alert warn" style="margin:0 0 0">ğŸ”µ C.4722 : Dernier carat si dirigÃ© vers PAN Z depuis NSY voie M â†’ Solliciter l'AC</div>
        </div>
      </div>
    </div>

    <!-- Menaces -->
    <div class="ligne-section-title">Menaces identifiÃ©es</div>

    <div class="ligne-card">
      <div class="ligne-card-header" onclick="toggleLigne(this)" style="background:var(--red)">
        <span class="lc-ico">âš ï¸</span>
        <h3>Menaces â€” Points de vigilance</h3>
        <span class="lc-chev">â€º</span>
      </div>
      <div class="ligne-card-body">
        <div class="menace-row">
          <div class="menace-ico">ğŸ“</div>
          <div class="menace-content">
            <div class="menace-title">Signal Tableau G â€” C.2245 / C.2243 / C.2241</div>
            <div class="menace-sub">DirigÃ© vers Pantin Zone cÃ´tÃ© Province (voies L, M, 1Bis). 2 scÃ©narios : Avertissement â†’ SÃ©maphore (rÃ©ception voie occupÃ©e) Â· Ralent 30 â†’ Rappel R30 + Avertissement</div>
            <span class="menace-tag mtag-warn">Sens Impair</span><span class="menace-tag mtag-info">Voies L/M/1Bis</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸŒ‰</div>
          <div class="menace-content">
            <div class="menace-title">Signal Cv 2277 masquÃ© par le pont</div>
            <div class="menace-sub">Sortie de Pantin Z cÃ´tÃ© Province. Respecter la Marche restrictive et adapter sa vitesse pour Ãªtre en mesure de s'arrÃªter devant le signal</div>
            <span class="menace-tag mtag-danger">Masquage signal</span><span class="menace-tag mtag-warn">Sortie PAN Z</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">â–²</div>
          <div class="menace-content">
            <div class="menace-title">Signal Cv 349 â€” commun aux 3 voies (Voie 7)</div>
            <div class="menace-sub">Sortie de Pantin Z cÃ´tÃ© Province voie 7. Marquer l'arrÃªt au chevron âš ï¸ â€” Solliciter l'AUM auprÃ¨s du poste B1</div>
            <span class="menace-tag mtag-danger">ArrÃªt obligatoire</span><span class="menace-tag mtag-info">Voie 7 â€” B1</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸ”¢</div>
          <div class="menace-content">
            <div class="menace-title">TIVD 30 au PK 3.1 â€” Voie L cÃ´tÃ© Paris</div>
            <div class="menace-sub">Le TIVD30 implantÃ© au-dessus de la voie L peut porter Ã  confusion (L ou M). Ce TIV concerne bien la Voie L</div>
            <span class="menace-tag mtag-warn">Confusion voie L/M</span><span class="menace-tag mtag-info">PK 3.1</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸ’¡</div>
          <div class="menace-content">
            <div class="menace-title">Tableau FB Ã©teint â€” EntrÃ©e Noisy FB</div>
            <div class="menace-sub">Si signal C1 en avertissement ET tableau FB Ã©teint â†’ train peut Ãªtre dirigÃ© vers C5 ou C2. Des pancartes ARRÃŠT au bout ont Ã©tÃ© franchies plusieurs fois âš ï¸</div>
            <span class="menace-tag mtag-danger">Franchissement pancarte ARRÃŠT</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">âš¡</div>
          <div class="menace-content">
            <div class="menace-title">EntrÃ©e Pantin FV â€” Cv 404 : Ne pas avoir l'indication D</div>
            <div class="menace-sub">Si indication D prÃ©sentÃ©e â†’ train dirigÃ© vers voie D1 (station-service) non Ã©lectrifiÃ©e â›”</div>
            <span class="menace-tag mtag-danger">Voie non Ã©lectrifiÃ©e</span><span class="menace-tag mtag-warn">Pantin FV</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸ›‘</div>
          <div class="menace-content">
            <div class="menace-title">Signal C.2275 â€” Ralent 30 impÃ©ratif (PK 4.3 voie L)</div>
            <div class="menace-sub">Ralent 30 impÃ©ratif pour accÃ©der aux faisceaux D & V cÃ´tÃ© Province. SÃ©quence : C.2275 â†’ C.259 (LAV 400m âš ï¸) â†’ C.357</div>
            <span class="menace-tag mtag-danger">R30 impÃ©ratif</span><span class="menace-tag mtag-info">Faisceaux D&amp;V</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸš¦</div>
          <div class="menace-content">
            <div class="menace-title">Circulation 1EO et 2EO â€” Vitesses diffÃ©rentes selon EM</div>
            <div class="menace-sub">Vitesses varient selon le type d'EM (B16C, E32C, E14F, E14R, E14P, V140, V120, ME100, MA80). VÃ©rifier au Livret de lignes VO00925 âš ï¸ Non mis Ã  jour</div>
            <span class="menace-tag mtag-warn">Vitesse EM-dÃ©pendante</span>
            <div class="menace-sub" style="margin-top:6px;font-weight:600">âš ï¸ RAPPEL : En sens impair, circulation sur 1EO ne permet PAS d'Ãªtre dirigÃ© vers les faisceaux de Pantin</div>
          </div>
        </div>
      </div>
    </div>

    <!-- MÃ©thodologie VS -->
    <div class="ligne-section-title">MÃ©thodologie circulation sur VS</div>
    <div class="ligne-card">
      <div class="ligne-card-header" onclick="toggleLigne(this)" style="background:var(--teal)">
        <span class="lc-ico">ğŸ“</span>
        <h3>Marche en manÅ“uvre â€” VS</h3>
        <span class="lc-chev">â€º</span>
      </div>
      <div class="ligne-card-body">
        <div class="alert warn" style="margin:12px 16px">â‰¤ 30 km/h Â· Prudence Â· PrÃªt Ã  obÃ©ir aux signaux</div>
        <div class="methodologie-item">
          <div class="meth-dist">âˆ’200m</div>
          <div class="meth-rule">Circuler Ã  <strong>20 km/h maximum</strong></div>
        </div>
        <div class="methodologie-item">
          <div class="meth-dist">âˆ’100m</div>
          <div class="meth-rule">Circuler Ã  <strong>10 km/h maximum</strong></div>
        </div>
        <div class="methodologie-item">
          <div class="meth-dist">Derniers m</div>
          <div class="meth-rule">TrÃ¨s faible allure pour garantir le point d'arrÃªt</div>
        </div>
        <div class="methodologie-item">
          <div class="meth-dist" style="background:var(--amber)">MÃ©tÃ©o</div>
          <div class="meth-rule" style="color:var(--amber)">RÃ©duire vitesse en conditions dÃ©favorables</div>
        </div>
        <div style="padding:12px 16px;border-top:1px solid var(--border2)">
          <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">âš ï¸ Risques et particularitÃ©s</div>
          <div style="font-size:12px;color:var(--text2);line-height:1.6">
            â€¢ Rail glissant : risque d'enrayage<br>
            â€¢ Traverses peintes en blanc et chevrons difficilement visibles<br>
            â€¢ PAN Z : certaines voies courtes, bien tirer aux TLC<br>
            â€¢ Calcul distance : supports catÃ©naire (~50m) Â· rames voies contiguÃ«s Â· pancartes
          </div>
        </div>
      </div>
    </div>

    <!-- Borne Lumisafe -->
    <div class="ligne-section-title">Borne Lumisafe â€” Noisy FB</div>
    <div class="ligne-card">
      <div class="ligne-card-header" onclick="toggleLigne(this)" style="background:var(--navy-mid)">
        <span class="lc-ico">ğŸš¨</span>
        <h3>Ã‰tats borne Lumisafe</h3>
        <span class="lc-chev">â€º</span>
      </div>
      <div class="ligne-card-body">
        <div class="menace-row">
          <div class="menace-ico" style="color:var(--green)">ğŸŸ¢</div>
          <div class="menace-content">
            <div class="menace-title" style="color:var(--green)">Feu vert + Damier effacÃ©</div>
            <div class="menace-sub"><strong>VOIE NON PROTÃ‰GÃ‰E</strong> â€” Je peux monter sur l'Engin Moteur âœ…</div>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico" style="color:var(--amber)">ğŸŸ¡</div>
          <div class="menace-content">
            <div class="menace-title" style="color:var(--amber)">Feu orange + Damier effacÃ©</div>
            <div class="menace-sub"><strong>VOIE PROTÃ‰GÃ‰E</strong> â€” MontÃ©e interdite Â· Contacter OC Train âš ï¸</div>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico" style="color:var(--red)">ğŸ”´</div>
          <div class="menace-content">
            <div class="menace-title" style="color:var(--red)">Feu rouge fixe + Damier prÃ©sentÃ©</div>
            <div class="menace-sub"><strong>VOIE PROTÃ‰GÃ‰E</strong> â€” MontÃ©e sur EM interdite Â· Contacter immÃ©diatement OC Train ğŸš«</div>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico" style="color:var(--red)">ğŸ”´</div>
          <div class="menace-content">
            <div class="menace-title" style="color:var(--red)">Feu rouge clignotant + Damier prÃ©sentÃ©</div>
            <div class="menace-sub"><strong>VOIE PROTÃ‰GÃ‰E</strong> â€” MontÃ©e sur EM interdite Â· Contacter immÃ©diatement OC Train ğŸš«</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Points d'arrÃªt NSY -->
    <div class="ligne-section-title">Points d'arrÃªt â€” Noisy FB</div>
    <div class="ligne-card">
      <div class="ligne-card-header" onclick="toggleLigne(this)" style="background:var(--teal)">
        <span class="lc-ico">ğŸ¯</span>
        <h3>Implantation points d'arrÃªt NSY</h3>
        <span class="lc-chev">â€º</span>
      </div>
      <div class="ligne-card-body">
        <div class="menace-row">
          <div class="menace-ico">ğŸ“</div>
          <div class="menace-content">
            <div class="menace-title">Implantations diverses selon voie</div>
            <div class="menace-sub">RepÃ¨res au sol Â· Panneaux chevron Â· Borne bleue en bout de quai Â· Marque peinte sur voie Â· Poteau bleu numÃ©rotÃ© (voie 13 etc.). Bien identifier le bon repÃ¨re selon votre affectation.</div>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">âš™ï¸</div>
          <div class="menace-content">
            <div class="menace-title">Tour en fosse â€” Noisy</div>
            <div class="menace-sub">Zone spÃ©cifique avec accÃ¨s contrÃ´lÃ©. Poste M cÃ´tÃ© Metz. Chantier multitechnique. Respecter les consignes d'accÃ¨s et vitesses de secteur.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- REX -->
    <div class="ligne-section-title">Retours d'ExpÃ©rience (REX)</div>
    <div class="ligne-card">
      <div class="ligne-card-header" onclick="toggleLigne(this)" style="background:#1a1a1a">
        <span class="lc-ico">ğŸ“‹</span>
        <h3>REX â€” Incidents recensÃ©s</h3>
        <span class="lc-chev">â€º</span>
      </div>
      <div class="ligne-card-body">
        <div class="menace-row">
          <div class="menace-ico">ğŸ“…</div>
          <div class="menace-content">
            <div class="menace-title">11/10/2023 â€” Franchissement chevron pointe en haut</div>
            <div class="menace-sub">Voie 5, Pantin FD Â· Franchissement du chevron sans engagement du point protÃ©gÃ©</div>
            <span class="menace-tag mtag-danger">SÃ©curitÃ©</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸ“…</div>
          <div class="menace-content">
            <div class="menace-title">02/05/2024 â€” Mise en mouvement non autorisÃ©e</div>
            <div class="menace-sub">Pantin Zone Â· DÃ©part sans AUM valide</div>
            <span class="menace-tag mtag-danger">SÃ©curitÃ©</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸ“…</div>
          <div class="menace-content">
            <div class="menace-title">14/09/2023 â€” Tamponnement Z50000 Ã  12 km/h</div>
            <div class="menace-sub">Pantin FD Â· Tamponnement lors d'une manÅ“uvre sur voies lentes</div>
            <span class="menace-tag mtag-danger">Collision</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸ“…</div>
          <div class="menace-content">
            <div class="menace-title">Mars 2023 â€” Sortie de rame non autorisÃ©e du TPE de NSY</div>
            <div class="menace-sub">Noisy FB Â· Sortie sans autorisation du terrain propre Ã©tablissement</div>
            <span class="menace-tag mtag-danger">SÃ©curitÃ©</span>
          </div>
        </div>
        <div class="menace-row">
          <div class="menace-ico">ğŸ“…</div>
          <div class="menace-content">
            <div class="menace-title">Avril 2021 â€” Non-respect pancarte ARRÃŠT</div>
            <div class="menace-sub">Technicentre Paris-Est Â· DÃ©passement de la pancarte d'arrÃªt</div>
            <span class="menace-tag mtag-danger">Franchissement</span>
          </div>
        </div>
        <div style="padding:12px 16px">
          <div class="alert info" style="margin:0">ğŸ“± Saisir REX via <strong>DIGIBORNES â†’ REX</strong> â€” faire de chaque incident une opportunitÃ© d'amÃ©lioration</div>
        </div>
      </div>
    </div>

    <div style="height:8px"></div>

  </div><!-- /V-ligne -->

  <!-- â•â•â•â•â•â•â•â• POSTES â•â•â•â•â•â•â•â• -->
  <div id="V-postes" class="view">

    <div class="view-section-title">Contacts Paris-Est</div>
    <div class="poste-card">
      <div class="poste-row" onclick="copyPoste('PE Â· PAD / Poste 1 / Superviseur')">
        <div class="poste-ico" style="background:var(--navy-light)">ğŸ¢</div>
        <div class="poste-info">
          <div class="poste-name">Paris-Est (PE)</div>
          <div class="poste-details">PAD Â· Poste 1 Â· Superviseur</div>
        </div>
        <div class="poste-badge">
          <div class="poste-type pad">PAD</div>
        </div>
      </div>
      <div class="poste-row" onclick="copyPoste('PAN Z Â· SLD / Poste Z / Coordinateur')">
        <div class="poste-ico" style="background:var(--blue-light)">ğŸ”µ</div>
        <div class="poste-info">
          <div class="poste-name">PAN Z</div>
          <div class="poste-details">SLD Â· Poste Z Â· Coordinateur</div>
        </div>
        <div class="poste-badge">
          <div class="poste-type sld">SLD</div>
        </div>
      </div>
      <div class="poste-row" onclick="copyPoste('PAN TR Â· Auto Verbale / Poste B1 / APT')">
        <div class="poste-ico" style="background:var(--amber-light)">ğŸŸ¡</div>
        <div class="poste-info">
          <div class="poste-name">PAN TR</div>
          <div class="poste-details">Auto Verbale Â· Poste B1 Â· APT</div>
        </div>
        <div class="poste-badge">
          <div class="poste-type av">AV</div>
        </div>
      </div>
      <div class="poste-row" onclick="copyPoste('PAN FV Â· Auto Verbale / Poste B7 / Coordinateur')">
        <div class="poste-ico" style="background:var(--amber-light)">ğŸŸ¡</div>
        <div class="poste-info">
          <div class="poste-name">PAN FV</div>
          <div class="poste-details">Auto Verbale Â· Poste B7 Â· Coordinateur</div>
        </div>
        <div class="poste-badge">
          <div class="poste-type av">AV</div>
        </div>
      </div>
      <div class="poste-row" onclick="copyPoste('NSY FB Â· SLD / Poste FB / GEOPS')">
        <div class="poste-ico" style="background:var(--teal-light)">ğŸŸ¢</div>
        <div class="poste-info">
          <div class="poste-name">NSY FB</div>
          <div class="poste-details">SLD Â· Poste FB Â· GEOPS</div>
        </div>
        <div class="poste-badge">
          <div class="poste-type sld">SLD</div>
        </div>
      </div>
    </div>

    <div class="view-section-title">Contacts Cantons</div>
    <div class="poste-card">
      <div class="poste-row" onclick="copyPoste('C21/22 Â· Poste de ChÃ¢teau-Landon')">
        <div class="poste-ico" style="background:var(--surface2)">ğŸ </div>
        <div class="poste-info">
          <div class="poste-name">C21 / C22</div>
          <div class="poste-details">Poste de ChÃ¢teau-Landon</div>
        </div>
      </div>
      <div class="poste-row" onclick="copyPoste('C2XX Â· B1')">
        <div class="poste-ico" style="background:var(--surface2)">ğŸ“</div>
        <div class="poste-info"><div class="poste-name">C2XX</div><div class="poste-details">B1</div></div>
      </div>
      <div class="poste-row" onclick="copyPoste('C3XX Â· B7')">
        <div class="poste-ico" style="background:var(--surface2)">ğŸ“</div>
        <div class="poste-info"><div class="poste-name">C3XX</div><div class="poste-details">B7</div></div>
      </div>
      <div class="poste-row" onclick="copyPoste('C47X Â· Poste G')">
        <div class="poste-ico" style="background:var(--surface2)">ğŸ“</div>
        <div class="poste-info"><div class="poste-name">C47X</div><div class="poste-details">Poste G</div></div>
      </div>
      <div class="poste-row" onclick="copyPoste('BPL(FIEF) Â· C21/22 ChÃ¢teau-Landon')">
        <div class="poste-ico" style="background:var(--navy-light)">ğŸ”‘</div>
        <div class="poste-info">
          <div class="poste-name">BPL(FIEF)</div>
          <div class="poste-details">C21/22 â†’ ChÃ¢teau-Landon</div>
        </div>
      </div>
    </div>

    <div class="view-section-title">Articles du RÃ©fÃ©rentiel</div>
    <div class="ref-card">
      <h4>ğŸ“– Prise de Service</h4>
      <div class="ref-article">
        <div class="ref-code">D 25.02</div>
        <div class="ref-desc">OpÃ©rations par le conducteur prenant â€” relÃ¨ve, bulletins, ordres, GSM-GFU, SURCHARGE, VA en marche.</div>
      </div>
      <div class="ref-article">
        <div class="ref-code">E 24.03</div>
        <div class="ref-desc">DÃ©termination de l'opÃ©ration technique (PC, RS, RSr, MS). Signalisation de protection sur EM.</div>
      </div>
      <div class="ref-article">
        <div class="ref-code">E 23.07</div>
        <div class="ref-desc">Carnet de bord â€” consultation Ã  la premiÃ¨re occasion favorable.</div>
      </div>
      <div class="ref-article">
        <div class="ref-code">D 13.03</div>
        <div class="ref-desc">Service du train â€” portes, remise d'ordres, annonce.</div>
      </div>
      <div class="ref-article">
        <div class="ref-code">D 21.01</div>
        <div class="ref-desc">Signalisation d'avant des trains â€” vÃ©rification obligatoire en prise de service.</div>
      </div>
      <div class="ref-article">
        <div class="ref-code">E 41.01</div>
        <div class="ref-desc">ODICEO â€” gestion des ordres, activation sur SIRIUS ou smartphone professionnel.</div>
      </div>
      <div class="ref-article">
        <div class="ref-code">D 24.04</div>
        <div class="ref-desc">AdhÃ©rence dÃ©gradÃ©e â€” patinages, enrayages. Mesures FMN.</div>
      </div>
      <div class="ref-article">
        <div class="ref-code">D 13.01</div>
        <div class="ref-desc">Autorisation de Mouvement (AuM) â€” Signal, Lili, Verbale, Ã‰crite, Ã  Main.</div>
      </div>
    </div>

    <div class="view-section-title">Ã€ propos</div>
    <div class="section">
      <div class="row">
        <div class="row-left"><span style="font-size:20px">ğŸš„</span>
          <div>
            <div class="row-label">Prise de Service FMN</div>
            <div class="row-sub">Version 3.0 Â· Paris-Est Â· 2025</div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="row-left"><span style="font-size:20px">ğŸ“˜</span>
          <div>
            <div class="row-label">RÃ©fÃ©rentiel FMN v02</div>
            <div class="row-sub">Septembre 2025 â€” 318 articles</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /V-postes -->

  <!-- â•â•â•â•â•â•â•â• HISTORIQUE â•â•â•â•â•â•â•â• -->
  <div id="V-hist" class="view">
    <div class="hist-header">
      <h2>ğŸ“Š Historique</h2>
      <span class="hist-count" id="HIST-cnt">0</span>
    </div>
    <button class="export-btn" onclick="exportCSV()">ğŸ“¤ Exporter en CSV</button>
    <div id="HIST-list"></div>
  </div>

</div><!-- /VIEWS -->
</div><!-- /APP -->

<!-- â•â•â•â•â•â•â•â•â•â• BOTTOM BAR â•â•â•â•â•â•â•â•â•â• -->
<div id="BTM">
  <button class="btn btn-primary" onclick="valider()">âœ… Valider et Enregistrer</button>
  <div class="btn-row">
    <button class="btn btn-danger" onclick="confirmReset()">ğŸ”„ RÃ©initialiser</button>
    <button class="btn btn-sec"    onclick="goTab('hist')">ğŸ“Š Historique</button>
    <button class="btn btn-teal"   onclick="goTab('checklist')">âœ… Checklist</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• OVERLAY / SHEET â•â•â•â•â•â•â•â•â•â• -->
<div id="OVL" onclick="ovlBg(event)">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div id="OVL-BODY"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â• -->
<div id="TOAST"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECKLIST DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CL_DATA = {
  PC: {
    NAT: [
      {
        phase: 'A', title: 'ExtÃ©rieur + VÃ©rifications prÃ©alables cabine', color: '#001E62',
        items: [
          { id:'pca1',  t: 'S\'assurer prÃ©sence catÃ©naire au-dessus de chaque pantographe', sub:'ExtÃ©rieur â€” vÃ©rification visuelle', tags:['ref:PR'] },
          { id:'pca2',  t: 'Extinction LS(400)PC', sub:'Lampe prise 400V connectÃ©e', tags:['ref:Art.34'] },
          { id:'pca3',  t: 'Extinction LS-BL (autre cabine utilisÃ©e au BSI)', tags:['ref:Annexe 5B'] },
          { id:'pca4',  t: 'Si LS(SI)BA BATTERIE BASSE allumÃ©e â†’ Fermer DJ le plus rapidement possible', sub:'Condition', tags:['ref:Art.2.1'] },
          { id:'pca5',  t: 'MP(T-F) sur "FU"', sub:'Si pas dÃ©jÃ  en position' },
          { id:'pca6',  t: 'Appuyer BP-Q-BA (fermeture relais batterie)', tags:['ref:Annexe 5A'] },
          { id:'pca7',  t: 'Z(SE)LFR-LPRF sur "NORMAL"', tags:['ref:Annexe 5A'] },
          { id:'pca8',  t: 'Toucher l\'Ã©cran SIAC' },
          { id:'pca9',  t: 'VÃ©rifier initialisation SIE', sub:'DÃ©filement des points Ã  la fin du message' },
          { id:'pca10', t: 'Tous les Z BL sur "ARRÃŠT" et Z-PT sur "0"', tags:['ref:Annexe 5A'] },
          { id:'pca11', t: 'DÃ©verrouiller la BL (boÃ®te Ã  leviers)' },
          { id:'pca12', t: 'VÃ©rifier clignotement LS-SF' },
          { id:'pca13', t: 'Assurer signalisation d\'extrÃ©mitÃ©', tags:['ref:Art.39'] },
          { id:'pca14', t: 'Allumage LS-FU au BSI + BPL-J(0) au pupitre + position "0" Z(CO)', tags:['ref:Annexe 5B'] },
          { id:'pca15', t: 'VÃ©rifier signalisation extÃ©rieure sur Ã©cran SIAC', tags:['ref:Art.67'] },
          { id:'pca16', t: 'VÃ©rifier apparition touche GDI sur SIAC', tags:['ref:Annexe 5D'] },
          { id:'pca17', t: 'Placer et maintenir Z(TEST)LAMPES en position haute', sub:'VÃ©rifier allumage de toutes les lampes BSI' },
          { id:'pca18', t: 'VÃ©rifier lampes BPL (AUT, DVR, SE) GA et DO allumÃ©es' },
          { id:'pca19', t: 'VÃ©rifier LS(FP) allumÃ©es GA et DO' },
          { id:'pca20', t: 'VÃ©rifier LS(MM-CL) GA/DO + BPL(FIEF) allumÃ©s' },
          { id:'pca21', t: 'VÃ©rifier LS(SI)BA + BPL-J(0) + BPL-J(ARR/AV) allumÃ©s' },
          { id:'pca22', t: 'VÃ©rifier BP(URG)PT allumÃ©' },
          { id:'pca23', t: 'RelÃ¢cher Z(TEST)LAMPES' },
          { id:'pca24', t: 'VÃ©rifier prÃ©sence KVB sur IHM CCD', sub:'Ã‰lÃ©ment Ã©quipÃ© STM autonome', tags:['ref:Annexe 5E'] },
          { id:'pca25', t: 'VÃ©rifier LS(CO)FIS allumÃ© au BSI', tags:['ref:Annexe 5B'] },
          { id:'pca26', t: 'Si LS(CO)FIS=0 â†’ Appuyer BP(S)FIS', sub:'Condition â€” puis vÃ©rifier allumage', tags:['ref:Art.41'] },
        ]
      },
      {
        phase: 'B', title: 'Mise sous tension', color: '#0055A4',
        items: [
          { id:'pcb1', t: 'Commander montÃ©e du ou des pantographes', tags:['ref:Art.1.1'] },
          { id:'pcb2', t: 'Fermer le ou les disjoncteurs', tags:['ref:Art.2.1'] },
          { id:'pcb3', t: 'VÃ©rifier extinction LS(SI)BA', tags:['ref:Annexe 5A'] },
        ]
      },
      {
        phase: 'C', title: 'Dotations & Ã‰quipements de sÃ©curitÃ©', color: '#005F73',
        items: [
          { id:'pcc1', t: 'Extincteurs', sub:'PrÃ©sence dans le couloir (partie inf. ABT2)', tags:['ref:PR'] },
          { id:'pcc2', t: 'AgrÃ¨s de protection et de signalisation' },
          { id:'pcc3', t: 'Documents de bord', sub:'Sous le pupitre Ã  gauche' },
          { id:'pcc4', t: 'Housse de protection de l\'attelage', sub:'Coffre cÃ´tÃ© siÃ¨ge accompagnateur' },
          { id:'pcc5', t: 'Rampe amovible', sub:'Partie infÃ©rieure ABT1' },
          { id:'pcc6', t: 'AgrÃ¨s comble-lacune' },
          { id:'pcc7', t: 'VÃ©rifier fonctionnement lanterne' },
          { id:'pcc8', t: 'Plombage coffre cabine ABT1' },
          { id:'pcc9', t: 'PoignÃ©e mobile d\'isolement du frein' },
          { id:'pcc10', t: 'Cales anti-dÃ©rive' },
          { id:'pcc11', t: 'ATESS', sub:'VÃ©rifications fiche de repÃ©rage' },
        ]
      },
      {
        phase: 'D', title: 'Essais d\'appareillage', color: '#C8102E',
        items: [
          { id:'pcd1', t: 'Appuyer BPL(FIEF) pour essai freins', tags:['ref:Annexe 5A'] },
          { id:'pcd2', t: 'VÃ©rifier allumage BPL(FIEF)' },
          { id:'pcd3', t: 'Placer MP(T-F) sur "0"' },
          { id:'pcd4', t: 'VÃ©rifier allumage LS(FIS-S) TOUS SERRÃ‰S au BSI', tags:['ref:Annexe 5B'] },
          { id:'pcd5', t: 'EFAS â€” Essai du frein Ã  agent seul', tags:['ref:Art.3'] },
          { id:'pcd6', t: 'Appuyer BP(FIEF) pour supprimer fonction FIEF', tags:['ref:Annexe 5A'] },
          { id:'pcd7', t: 'VÃ©rifier extinction BP(FIEF)' },
          { id:'pcd8', t: 'Essai VA', sub:'PrÃ©requis : BP(FIEF)=1 ; RST KO', tags:['ref:Art.4','prereq:BP(FIEF)=1 ; RST KO'] },
          { id:'pcd9', t: 'Essai SAL (signal d\'alerte lumineux)', sub:'PrÃ©requis : pas de circulation en face', tags:['prereq:Pas de circulation en face'] },
          { id:'pcd10', t: 'Mettre en service + essai RST radio sol-trains', tags:['ref:PR'] },
          { id:'pcd11', t: 'Essai de sonorisation', tags:['ref:Art.42'] },
        ]
      },
      {
        phase: 'E', title: 'OpÃ©rations finales', color: '#1A7A3C',
        items: [
          { id:'pce1', t: 'VÃ©rifier absence du symbole muet sur barre IHM SIAC', tags:['ref:Annexe 5D'] },
          { id:'pce2', t: 'Initialiser SIVE (en service commercial, sur voie de dÃ©part)', tags:['ref:Art.72'] },
          { id:'pce3', t: 'Commander autorisation manuelle ouverture portes selon config quai', tags:['ref:Art.36.4'] },
          { id:'pce4', t: 'Annoter carnet de bord si nÃ©cessaire', tags:['ref:Art.69.7'] },
          { id:'pce5', t: 'Appuyer BP(D)FIS', tags:['ref:Annexe 5A','ref:Art.41'] },
          { id:'pce6', t: 'VÃ©rifier extinction LS(CO)FIS au BSI', tags:['ref:Annexe 5B'] },
        ]
      }
    ],
    Z2N: [
      {
        phase: 'A', title: 'ExtÃ©rieur + VÃ©rifications prÃ©alables cabine', color: '#001E62',
        items: [
          { id:'z_pca1',  t: 'VÃ©rifier prÃ©sence catÃ©naire au-dessus de chaque pantographe', sub:'ExtÃ©rieur â€” vÃ©rification visuelle' },
          { id:'z_pca2',  t: 'Extinction lampe PRISE 400V CONNECTÃ‰E (LS-400V)' },
          { id:'z_pca3',  t: 'Extinction lampe AUTRE CABINE UTILISÃ‰E (LS-AUTRE CAB)' },
          { id:'z_pca4',  t: 'Si lampe BATTERIE BASSE allumÃ©e â†’ Fermer DIS rapidement', sub:'Condition â€” prioritÃ© batterie' },
          { id:'z_pca5',  t: 'MP(T-F) sur position "FU"' },
          { id:'z_pca6',  t: 'Appuyer BP-BA (bouton fermeture relais batterie)' },
          { id:'z_pca7',  t: 'Commutateur secours feux signalisation sur "NORMAL"' },
          { id:'z_pca8',  t: 'Appuyer BP(TEST)LS â€” test lampes tableau de bord' },
          { id:'z_pca9',  t: 'VÃ©rifier LS2(G)=1 et LS(SNU)=1' },
          { id:'z_pca10', t: 'VÃ©rifier toutes les lampes armoire BT=1' },
          { id:'z_pca11', t: 'VÃ©rifier LS-AUTRE CABINE UTILISÃ‰E=1' },
          { id:'z_pca12', t: 'RelÃ¢cher BP(TEST)LS â€” vÃ©rifier LS-ISO SECU=0' },
          { id:'z_pca13', t: 'DÃ©verrouiller la BL (boÃ®te Ã  leviers)' },
          { id:'z_pca14', t: 'VÃ©rifier clignotement LS-SF' },
          { id:'z_pca15', t: 'Assurer signalisation d\'extrÃ©mitÃ©' },
          { id:'z_pca16', t: 'VÃ©rifier allumage LS-FU + BPL-J(0) + Z(CO)=1 au pupitre' },
          { id:'z_pca17', t: 'VÃ©rifier LS(FP)=1' },
          { id:'z_pca18', t: 'VÃ©rifier extinction LS-INCENDIE' },
          { id:'z_pca19', t: 'Appuyer BP(TEST)LS armoire BT â€” vÃ©rifier cli LS-INCENDIE' },
          { id:'z_pca20', t: 'VÃ©rifier DIP effacÃ©' },
          { id:'z_pca21', t: 'VÃ©rifier plombage Z(VA), Z(RS), Z(IS-FP), Z(IS-KVB), Z(IS-AL), Z(IS-SIVE) motrice 1', sub:'Si Ã©quipÃ©' },
          { id:'z_pca22', t: 'VÃ©rifier LS-AUTRE CAB=0' },
          { id:'z_pca23', t: 'Maintenir puis relÃ¢cher BP(MTS)' },
          { id:'z_pca24', t: 'Contact poste selon gare', sub:'PE: PAD/Poste 1 Â· PAN Z: SLD/Poste Z Â· PAN TR: B1/APT', tags:['ref:Postes'] },
        ]
      },
      {
        phase: 'B', title: 'Mise sous tension', color: '#0055A4',
        items: [
          { id:'z_pcb1', t: 'Commander montÃ©e pantographes' },
          { id:'z_pcb2', t: 'Fermer le ou les disjoncteurs (DIS)' },
          { id:'z_pcb3', t: 'VÃ©rifier extinction lampe BATTERIE BASSE' },
        ]
      },
      {
        phase: 'C', title: 'VÃ©rifications compartiment + pupitre', color: '#005F73',
        items: [
          { id:'z_pcc1', t: 'Tous les CC et DIS=0 (disjoncteurs)' },
          { id:'z_pcc2', t: 'Tous les Z sur "N" (position normale)' },
          { id:'z_pcc3', t: 'AgrÃ¨s de protection et signalisation' },
          { id:'z_pcc4', t: 'AgrÃ¨s de sÃ©curitÃ©' },
          { id:'z_pcc5', t: 'Plombage caisse Ã  outils' },
          { id:'z_pcc6', t: 'ATESS (cf. fiche de repÃ©rage)' },
          { id:'z_pcc7', t: 'VÃ©rifier CP (cylindres de frein) 7â€“9 bars Ã  la pdr' },
          { id:'z_pcc8', t: 'Z(Chauffage) et Z(Ã‰clairage)=1' },
          { id:'z_pcc9', t: 'VÃ©rifier label rÃ©glage RST' },
          { id:'z_pcc10', t: 'Appuyer marche RST' },
        ]
      },
      {
        phase: 'C', title: 'Frein â€” Mise en service', color: '#005F73',
        items: [
          { id:'z_pcc11', t: 'Z(FIEF) sur "SERRE"' },
          { id:'z_pcc12', t: 'VÃ©rifier montÃ©e pression CF1 au mano CF' },
          { id:'z_pcc13', t: 'Mettre frein en service' },
          { id:'z_pcc14', t: 'BP(SURCHARGE)=1 â†’ LS(SUR)=1' },
          { id:'z_pcc15', t: 'Attendre stabilisation CG (1 min minimum)', sub:'â± 60 secondes min', tags:['prereq:Attente 1 min'] },
          { id:'z_pcc16', t: 'BP(SURCHARGE) â†’ attendre Ã©limination (3 min)', sub:'â± 3 minutes', tags:['prereq:Attente 3 min'] },
        ]
      },
      {
        phase: 'D', title: 'Essais d\'appareillage', color: '#C8102E',
        items: [
          { id:'z_pcd1', t: 'Ã‰tanchÃ©itÃ© CG (conduite gÃ©nÃ©rale)' },
          { id:'z_pcd2', t: 'Fonctionnement frein automatique + Ã©tanchÃ©itÃ© RE', sub:'N/A sur TM606' },
          { id:'z_pcd3', t: '2Ã— BP(URG) â€” essai commande urgence' },
          { id:'z_pcd4', t: 'EAS â€” Essai Automatique de SÃ©curitÃ© frein continu' },
          { id:'z_pcd5', t: 'Essai traction', sub:'PrÃ©requis: Z(FIEF)=1; CG 5 bars; Sens marche', tags:['prereq:Z(FIEF)=1; CG 5bars; Sens marche'] },
          { id:'z_pcd6', t: 'Essai VA', sub:'PrÃ©requis: Z(FIEF)=1; CG 5 bars; Sens marche; RST KO', tags:['prereq:Z(FIEF)=1; CG 5bars; RST KO'] },
          { id:'z_pcd7', t: 'Essai KVB', sub:'PrÃ©requis: Z(FIEF)=1; CG 5 bars', tags:['prereq:Z(FIEF)=1; CG 5bars'] },
          { id:'z_pcd8', t: 'Essai SAL', sub:'PrÃ©requis: pas de circulation en face', tags:['prereq:Pas de circulation en face'] },
          { id:'z_pcd9', t: 'Indexer RST (NÂ° Canal + NUTRA)' },
          { id:'z_pcd10', t: 'Z(FIEF) sur "DESSERRE"' },
          { id:'z_pcd11', t: 'Observer vidange CF1' },
          { id:'z_pcd12', t: 'DÃ©pression 1 bar Ã  la CG' },
        ]
      },
      {
        phase: 'E', title: 'OpÃ©rations finales', color: '#1A7A3C',
        items: [
          { id:'z_pce1', t: 'Initialiser le SIVE (si Ã©quipÃ©)' },
          { id:'z_pce2', t: 'VÃ©rifier absence symbole muet tableau de bord' },
          { id:'z_pce3', t: 'Effectuer mise en service nuit' },
          { id:'z_pce4', t: 'Autoriser ouverture/fermeture portes' },
          { id:'z_pce5', t: 'BP(TEST-DF)AE-FEM â†’ LS-DEFAUT AE=0' },
          { id:'z_pce6', t: 'Annoter CB si nÃ©cessaire' },
          { id:'z_pce7', t: 'Appuyer BP(CO)FIS â€” vÃ©rifier extinction LS(CO)FIS' },
          { id:'z_pce8', t: 'DÃ©prÃ©paration rame via SIAC / tableau de bord' },
          { id:'z_pce9', t: 'Appuyer BP(A)BA' },
        ]
      }
    ]
  },
  RS: {
    NAT: [
      {
        phase: 'A', title: 'OpÃ©rations & VÃ©rifications prÃ©alables', color: '#001E62',
        items: [
          { id:'rsa1',  t: 'S\'assurer prÃ©sence catÃ©naire au-dessus de chaque pantographe', tags:['ref:PR'] },
          { id:'rsa2',  t: 'Extinction LS(400)PC', tags:['ref:Art.34'] },
          { id:'rsa3',  t: 'Extinction LS-BL (autre cabine utilisÃ©e au BSI)', tags:['ref:Annexe 5B'] },
          { id:'rsa4',  t: 'Si LS(SI)BA BATTERIE BASSE allumÃ©e â†’ Fermer DJ rapidement', sub:'Condition', tags:['ref:Art.2.1'] },
          { id:'rsa5',  t: 'MP(T-F) sur "FU"' },
          { id:'rsa6',  t: 'Appuyer BP-Q-BA', tags:['ref:Annexe 5A'] },
          { id:'rsa7',  t: 'Z(SE)LFR-LPRF sur "NORMAL"', tags:['ref:Annexe 5A'] },
          { id:'rsa8',  t: 'Toucher l\'Ã©cran SIAC' },
          { id:'rsa9',  t: 'VÃ©rifier initialisation SIE' },
          { id:'rsa10', t: 'VÃ©rifier configuration du train', tags:['ref:Art.67'] },
          { id:'rsa11', t: 'Consulter les carnets de bord', tags:['ref:PR','ref:Art.69'] },
          { id:'rsa12', t: 'VÃ©rifier allumage VY(CO)URG et VY(CO)Z au BSI', tags:['ref:Annexe 5B'] },
          { id:'rsa13', t: 'VÃ©rifier signalisation extÃ©rieure sur SIAC', tags:['ref:Art.67'] },
          { id:'rsa14', t: 'VÃ©rifier apparition touche GDI sur SIAC', tags:['ref:Annexe 5D'] },
          { id:'rsa15', t: 'VÃ©rifier KVB sur IHM CCD', sub:'Ã‰lÃ©ment Ã©quipÃ© STM autonome', tags:['ref:Annexe 5E'] },
          { id:'rsa16', t: 'VÃ©rifier LS(CO)FIS=1 au BSI', tags:['ref:Annexe 5B'] },
          { id:'rsa17', t: 'Si LS(CO)FIS=0 â†’ Appuyer BP(S)FIS', sub:'Condition â€” puis vÃ©rifier', tags:['ref:Art.41'] },
        ]
      },
      {
        phase: 'B', title: 'Mise sous tension', color: '#0055A4',
        items: [
          { id:'rsb1', t: 'Commander montÃ©e du ou des pantographes', tags:['ref:Art.1.1'] },
          { id:'rsb2', t: 'Fermer le ou les disjoncteurs', tags:['ref:Art.2.1'] },
          { id:'rsb3', t: 'VÃ©rifier extinction LS(SI)BA', tags:['ref:Annexe 5A'] },
        ]
      },
      {
        phase: 'D', title: 'Essais d\'appareillage', color: '#C8102E',
        items: [
          { id:'rsd1', t: 'Essai du dispositif de VA', tags:['ref:Art.4','prereq:Voir Art.4'] },
          { id:'rsd2', t: 'Mettre en service + essai RST radio sol-trains', tags:['ref:PR'] },
          { id:'rsd3', t: 'Essai de sonorisation', tags:['ref:Art.42'] },
        ]
      },
      {
        phase: 'E', title: 'OpÃ©rations finales', color: '#1A7A3C',
        items: [
          { id:'rse1', t: 'VÃ©rifier absence du symbole muet sur IHM SIAC', tags:['ref:Annexe 5D'] },
          { id:'rse2', t: 'Initialiser SIVE (en service commercial, voie de dÃ©part)', tags:['ref:Art.72'] },
          { id:'rse3', t: 'Commander autorisation manuelle ouverture portes', tags:['ref:Art.36.4'] },
          { id:'rse4', t: 'Annoter carnet de bord si nÃ©cessaire', tags:['ref:Art.69.7'] },
          { id:'rse5', t: 'Appuyer BP(D)FIS', tags:['ref:Annexe 5A','ref:Art.41'] },
          { id:'rse6', t: 'VÃ©rifier extinction LS(CO)FIS au BSI', tags:['ref:Annexe 5B'] },
        ]
      }
    ],
    Z2N: [
      {
        phase: 'A', title: 'OpÃ©rations & VÃ©rifications prÃ©alables', color: '#001E62',
        items: [
          { id:'z_rsa1',  t: 'VÃ©rifier prÃ©sence catÃ©naire au-dessus de chaque pantographe' },
          { id:'z_rsa2',  t: 'Extinction LS-PRISE 400V CONNECTÃ‰E' },
          { id:'z_rsa3',  t: 'Extinction LS-AUTRE CABINE UTILISÃ‰E' },
          { id:'z_rsa4',  t: 'Si BATTERIE BASSE allumÃ©e â†’ Fermer DIS rapidement', sub:'Condition' },
          { id:'z_rsa5',  t: 'MP(T-F) sur "FU"' },
          { id:'z_rsa6',  t: 'Appuyer BP-BA (relais batterie)' },
          { id:'z_rsa7',  t: 'Commutateur secours feux signalisation sur "NORMAL"' },
          { id:'z_rsa8',  t: 'Appuyer BP(TEST)LS puis vÃ©rifier LS2(G)=1, LS(SNU)=1, toutes lampes BT=1' },
          { id:'z_rsa9',  t: 'RelÃ¢cher BP(TEST)LS â€” vÃ©rifier LS-ISO SECU=0' },
          { id:'z_rsa10', t: 'VÃ©rifier DIP effacÃ©' },
          { id:'z_rsa11', t: 'Consulter carnets de bord' },
          { id:'z_rsa12', t: 'VÃ©rifier configuration train / Ã©tat du train' },
          { id:'z_rsa13', t: 'Signalisation extÃ©rieure (tableau de bord)' },
          { id:'z_rsa14', t: 'Touche GDI affichÃ©e' },
          { id:'z_rsa15', t: 'KVB prÃ©sent' },
          { id:'z_rsa16', t: 'LS(CO)FIS=1 â€” si non, appuyer BP(S)FIS', tags:['ref:Art.41'] },
        ]
      },
      {
        phase: 'B', title: 'Mise sous tension', color: '#0055A4',
        items: [
          { id:'z_rsb1', t: 'Commander montÃ©e pantographes' },
          { id:'z_rsb2', t: 'Fermer le ou les DIS (disjoncteurs)' },
          { id:'z_rsb3', t: 'Extinction BATTERIE BASSE' },
        ]
      },
      {
        phase: 'D', title: 'Essais d\'appareillage', color: '#C8102E',
        items: [
          { id:'z_rsd1', t: 'Essai VA (dispositif vigilance autom.)', tags:['prereq:Sens marche engagÃ©'] },
          { id:'z_rsd2', t: 'Mettre en service RST + essai radio sol-trains' },
          { id:'z_rsd3', t: 'Essai sonorisation' },
        ]
      },
      {
        phase: 'E', title: 'OpÃ©rations finales', color: '#1A7A3C',
        items: [
          { id:'z_rse1', t: 'Absence symbole muet tableau de bord' },
          { id:'z_rse2', t: 'Initialiser SIVE (si Ã©quipÃ©)' },
          { id:'z_rse3', t: 'Autorisation ouverture portes' },
          { id:'z_rse4', t: 'Annoter CB si nÃ©cessaire' },
          { id:'z_rse5', t: 'Appuyer BP(D)FIS â€” extinction LS(CO)FIS' },
          { id:'z_rse6', t: 'DÃ©prÃ©paration rame' },
          { id:'z_rse7', t: 'Appuyer BP(A)BA' },
        ]
      }
    ]
  },
  RSr: {
    NAT: [
      {
        phase: 'U', title: 'Phase unique â€” RSr (Remise en Service RÃ©duite)', color: '#5C2D91',
        items: [
          { id:'rsr1',  t: 'Toucher l\'Ã©cran SIAC' },
          { id:'rsr2',  t: 'VÃ©rifier Ã©tat du train', tags:['ref:Art.66'] },
          { id:'rsr3',  t: 'Extinction LS-BL (autre cabine utilisÃ©e au BSI)', tags:['ref:Annexe 5B'] },
          { id:'rsr4',  t: 'VÃ©rifier extinction LS(SI)BA (batterie basse)', tags:['ref:Annexe 5A'] },
          { id:'rsr5',  t: 'Mettre en service poste de conduite â€” Maintien de service', tags:['ref:Art.18.1'] },
          { id:'rsr6',  t: 'VÃ©rifier signalisation extÃ©rieure du train au SIAC', tags:['ref:Art.67'] },
          { id:'rsr7',  t: 'VÃ©rifier apparition touche GDI au SIAC', tags:['ref:Annexe 5D'] },
          { id:'rsr8',  t: 'Consulter les carnets de bord', tags:['ref:PR','ref:Art.69'] },
          { id:'rsr9',  t: 'Effectuer opÃ©rations enregistreur vitesse / position signaux', tags:['ref:PR','ref:Art.70'] },
          { id:'rsr10', t: 'VÃ©rifier LS(CO)FIS=1 au BSI', tags:['ref:Annexe 5B'] },
          { id:'rsr11', t: 'Si LS(CO)FIS=0 â†’ Appuyer BP(S)FIS', sub:'Condition â€” puis vÃ©rifier', tags:['ref:Art.41'] },
          { id:'rsr12', t: 'Essai du dispositif de VA', tags:['ref:Art.4'] },
          { id:'rsr13', t: 'Mettre en service + essai RST radio sol-trains', tags:['ref:PR'] },
          { id:'rsr14', t: 'Essai de sonorisation', tags:['ref:Art.42'] },
          { id:'rsr15', t: 'Annoter carnet de bord si nÃ©cessaire', tags:['ref:Art.69.7'] },
          { id:'rsr16', t: 'VÃ©rifier absence symbole muet IHM SIAC', tags:['ref:Annexe 5D'] },
          { id:'rsr17', t: 'Commander autorisation ouverture portes', tags:['ref:Art.36.4'] },
          { id:'rsr18', t: 'Appuyer BP(D)FIS', tags:['ref:Art.41'] },
          { id:'rsr19', t: 'VÃ©rifier extinction LS(CO)FIS au BSI', tags:['ref:Annexe 5B'] },
        ]
      }
    ],
    Z2N: [
      {
        phase: 'U', title: 'Phase unique â€” RSr Z2N', color: '#5C2D91',
        items: [
          { id:'z_rsr1',  t: 'Appuyer BP(TEST)LS â€” vÃ©rifier Ã©tat train' },
          { id:'z_rsr2',  t: 'Extinction LS-AUTRE CABINE UTILISÃ‰E' },
          { id:'z_rsr3',  t: 'Extinction BATTERIE BASSE' },
          { id:'z_rsr4',  t: 'Mise en service â€” Maintien de service', sub:'Art. 18.1' },
          { id:'z_rsr5',  t: 'Signalisation extÃ©rieure (tableau de bord)' },
          { id:'z_rsr6',  t: 'Touche GDI affichÃ©e' },
          { id:'z_rsr7',  t: 'Consulter carnets de bord' },
          { id:'z_rsr8',  t: 'OpÃ©rations ATESS / enregistreur vitesse' },
          { id:'z_rsr9',  t: 'LS(CO)FIS=1 â€” si non, BP(S)FIS' },
          { id:'z_rsr10', t: 'Essai VA' },
          { id:'z_rsr11', t: 'Mettre en service RST + essai' },
          { id:'z_rsr12', t: 'Essai sonorisation' },
          { id:'z_rsr13', t: 'Annoter CB si nÃ©cessaire' },
          { id:'z_rsr14', t: 'Absence symbole muet' },
          { id:'z_rsr15', t: 'Autorisation portes' },
          { id:'z_rsr16', t: 'BP(D)FIS â€” extinction LS(CO)FIS' },
        ]
      }
    ]
  },
  MS: {
    NAT: [
      {
        phase: 'U', title: 'Phase unique â€” MS (Mise en Stationnement)', color: '#4A4A4A',
        items: [
          { id:'ms1', t: 'Annoter le carnet de bord si nÃ©cessaire', tags:['ref:Art.69.7'] },
          { id:'ms2', t: 'Commander fermeture des portes si pas dÃ©jÃ  fait', tags:['ref:Art.37'] },
          { id:'ms3', t: 'Descendre le store frontal', tags:['ref:Art.53'] },
          { id:'ms4', t: 'Commander dÃ©prÃ©paration de la rame via SIAC', tags:['ref:Art.78'] },
          { id:'ms5', t: 'Fermer les baies et les portes de la cabine de conduite' },
        ]
      }
    ],
    Z2N: [
      {
        phase: 'U', title: 'Phase unique â€” MS Z2N', color: '#4A4A4A',
        items: [
          { id:'z_ms1', t: 'Annoter carnet de bord si nÃ©cessaire' },
          { id:'z_ms2', t: 'Commander fermeture des portes' },
          { id:'z_ms3', t: 'Descendre le store frontal' },
          { id:'z_ms4', t: 'Effectuer opÃ©rations d\'isolement poste â€” Maintien de service', tags:['ref:Art.17.1'] },
          { id:'z_ms5', t: 'Fermer les baies et les portes de la cabine de conduite' },
        ]
      }
    ]
  }
};
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var TS    = { VAE: null, ARR: null };
var STORE = 'pds_fmn_v6';
var CL_STORE = 'pds_cl_v2';
var isUM  = false;
var clOp  = '';
var clMat = '';
var clChecked = {};   // { itemId: bool }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', function() {
  setToday('F-date');
  setToday('F-dep-d');
  dot('d-date', 'ok');
  dot('d-dep', 'ok');
  updateCount();
  loadCLState();
  updateProgress();
});

function setToday(id) {
  var d = new Date(), el = g(id, true);
  if (el) el.value = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ã‰TUDE DE LIGNE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleLigne(header) {
  header.classList.toggle('open');
  var body = header.nextElementSibling;
  body.classList.toggle('open');
}

// Auto-dÃ©tection EM depuis numÃ©ro saisi
var EM_DATABASE = [
  { pattern: /^Z?\s*5[0-9]{4}/i, label: 'Z 50000 â€” NAT', serie: 'NAT', icon: 'ğŸš„' },
  { pattern: /^5[0-9]{3}$/,       label: 'Z 50000 â€” NAT', serie: 'NAT', icon: 'ğŸš„' },
  { pattern: /^Z?\s*205\d\d/i,    label: 'Z 20500 â€” Z2N', serie: 'Z2N', icon: 'ğŸšŠ' },
  { pattern: /^Z?\s*209\d\d/i,    label: 'Z 20900 â€” Z2N', serie: 'Z2N', icon: 'ğŸšŠ' },
  { pattern: /^Z?\s*56\d\d/i,     label: 'Z 5600 â€” Z2N',  serie: 'Z2N', icon: 'ğŸšŠ' },
  { pattern: /^Z?\s*88\d\d/i,     label: 'Z 8800 â€” Z2N',  serie: 'Z2N', icon: 'ğŸšŠ' },
  { pattern: /^2[0-9]{4}$/,       label: 'Z 20x00 â€” Z2N', serie: 'Z2N', icon: 'ğŸšŠ' },
  { pattern: /^[1-9][0-9]{2}$/,   label: 'Z 50000 â€” NAT', serie: 'NAT', icon: 'ğŸš„' },
];

function detectEM(input, badgeId) {
  var val = input.value.trim();
  var badge = document.getElementById(badgeId);
  if (!badge) return;
  if (!val) { badge.style.display = 'none'; badge.innerHTML = ''; return; }
  var found = null;
  for (var i = 0; i < EM_DATABASE.length; i++) {
    if (EM_DATABASE[i].pattern.test(val)) { found = EM_DATABASE[i]; break; }
  }
  if (found) {
    badge.style.display = 'inline-flex';
    badge.className = 'em-detect-badge';
    badge.innerHTML = found.icon + ' ' + found.label;
    input.dataset.serie = found.serie;
    // Auto-sÃ©lection du matÃ©riel dans la checklist
    if (typeof selectMat === 'function') {
      selectMat(found.serie);
    }
  } else {
    badge.style.display = 'none';
    input.dataset.serie = '';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(t) {
  ['form','checklist','ligne','postes','hist'].forEach(function(n) {
    var tab  = document.getElementById('TAB-'+n);
    var view = document.getElementById('V-'+n);
    if (tab)  tab.classList.toggle('on', n===t);
    if (view) view.classList.toggle('on', n===t);
  });
  document.getElementById('BTM').style.display = (t === 'form') ? 'flex' : 'none';
  if (t === 'hist') renderHist();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dot(id, state) {
  var el = document.getElementById(id);
  if (!el) return;
  el.className = 'dot' + (state ? ' ' + state : '');
}
function dotTxt(id, inp) { dot(id, inp.value ? 'ok' : ''); updateProgress(); }
function dotSel(id, sel, mode) {
  var v = sel.value;
  // Colour the select
  sel.className = sel.className.replace(/\s*(ok|ko)-select/g, '');
  if (v==='OK'||v==='Oui') sel.classList.add('ok-select');
  else if (v==='KO'||v==='Non') sel.classList.add('ko-select');
  // Dot
  if (!id) return;
  if (mode==='okko')    dot(id, v==='OK' ? 'ok' : v==='KO' ? 'ko' : '');
  else if (mode==='ouinon') dot(id, v==='Oui' ? 'ok' : v==='Non' ? 'ko' : '');
  else dot(id, v ? 'ok' : '');
  updateProgress();
}
function dotPair(id, dId, hId) {
  var d = document.getElementById(dId).value;
  var h = document.getElementById(hId).value;
  dot(id, (d||h) ? 'ok' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROGRESS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var REQUIRED_FIELDS = ['F-date','F-train','F-op','F-mat','F-compo','F-nem1',
  'F-dep-d','F-dep-h','F-ldep','F-ppesol','F-sigav','F-va','F-kvb','F-rst','F-eas',
  'F-portes','F-ordres','F-annonce','F-aum','F-smc'];
function updateProgress() {
  var filled = 0;
  REQUIRED_FIELDS.forEach(function(id) {
    var el = document.getElementById(id);
    if (el && el.value) filled++;
  });
  var pct = Math.round((filled / REQUIRED_FIELDS.length) * 100);
  document.getElementById('PROG-BAR').style.width = pct + '%';
  document.getElementById('PROG-PCT').textContent  = pct + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE / DEP / HD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onDate() { dot('d-date', document.getElementById('F-date').value ? 'ok' : ''); updateProgress(); }
function onDep() {
  var h = document.getElementById('F-dep-h').value;
  var d = document.getElementById('F-dep-d').value;
  dot('d-dep', (d||h) ? 'ok' : '');
  if (h) {
    document.getElementById('HD-box').textContent = h;
    document.getElementById('HD-sub').textContent = 'HD = ' + h;
    dot('d-hd', 'info');
  } else {
    document.getElementById('HD-box').textContent = '--:--';
    document.getElementById('HD-sub').textContent = 'Auto depuis DÃ©part PrÃ©vu';
    dot('d-hd', '');
  }
  updateProgress();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPOSITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onCompo(sel) {
  dotSel('d-compo', sel, 'any');
  isUM = sel.value === 'UM';
  var r2  = document.getElementById('R-nem2');
  var l1  = document.getElementById('LBL-nem1');
  var s1  = document.getElementById('SUB-nem1');
  if (sel.value === 'US') {
    r2.classList.add('hidden');
    document.getElementById('F-nem2').value = '';
    l1.textContent = 'NÂ° EM';
    s1.textContent = 'US â€” engin moteur unique';
    toast('Composition US â€” 1 seul NÂ°EM', 'info');
  } else if (sel.value === 'UM') {
    r2.classList.remove('hidden');
    l1.textContent = 'NÂ° EM cÃ´tÃ© Paris';
    s1.textContent = 'UM â€” 1er Engin Moteur';
    toast('Composition UM â€” saisir 2 NÂ°EM', 'info');
  } else {
    r2.classList.add('hidden');
    l1.textContent = 'NÂ° EM';
    s1.textContent = "Choisir la composition d'abord";
  }
  updateProgress();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkPPESol() {
  var v = gv('F-ppesol');
  show('AL-eas', v === 'KO');
}
function checkPPEBord() {
  var ids = ['F-sigav','F-va','F-kvb','F-rst','F-eas'];
  var anyFilled = ids.some(function(id) { return gv(id) !== ''; });
  var allOK = ids.every(function(id) { return gv(id) === 'OK'; });
  var ban = document.getElementById('BAN-ppe');
  var txt = document.getElementById('BAN-ppe-t');
  if (!anyFilled) {
    ban.style.background = ''; ban.style.color = '';
    txt.textContent = 'PPE Bord â€” En attente de saisie';
  } else if (allOK) {
    ban.style.background = 'var(--green-light)'; ban.style.color = 'var(--green)';
    txt.textContent = 'âœ… PPE Bord â€” Conforme';
  } else {
    ban.style.background = 'var(--red-light)'; ban.style.color = 'var(--red)';
    txt.textContent = 'âš ï¸ PPE Bord â€” VÃ©rification requise';
  }
  updateProgress();
}
function checkST() {
  var ids = ['F-portes','F-ordres','F-annonce'];
  var anyFilled = ids.some(function(id) { return gv(id) !== ''; });
  var allOK = ids.every(function(id) { return gv(id) === 'OK'; });
  var ban = document.getElementById('BAN-st');
  var txt = document.getElementById('BAN-st-t');
  if (!anyFilled) {
    ban.style.background = ''; ban.style.color = '';
    txt.textContent = 'Service Train â€” En attente de saisie';
  } else if (allOK) {
    ban.style.background = 'var(--green-light)'; ban.style.color = 'var(--green)';
    txt.textContent = 'âœ… Service Train â€” Conforme';
  } else {
    ban.style.background = 'var(--red-light)'; ban.style.color = 'var(--red)';
    txt.textContent = 'âš ï¸ Service Train â€” VÃ©rification requise';
  }
  updateProgress();
}
function checkSiriusAD() { show('AL-sirius', gv('F-sad') === 'Oui'); }
function checkOdiceo()   { show('AL-odiceo', gv('F-odiceo') === 'Ordre en cours'); }
function checkRex()      { show('AL-rex', gv('F-rex') === 'Oui'); }
function checkDocADC() {
  var v = gv('F-docadc');
  show('R-docnum', v === 'Oui');
  if (v !== 'Oui') { document.getElementById('F-docnum').value = ''; dot('d-docnum', ''); }
}
function onVAE() {
  var v = gv('F-vae');
  show('AL-oae',        v === 'Oui');
  show('VAE-ts-block',  v === 'Oui');
  if (v !== 'Oui') { TS.VAE = null; document.getElementById('VAE-ts-txt').textContent = 'Non horodatÃ©e'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC OP â†’ CHECKLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncOpChecklist() {
  var op  = gv('F-op');
  var mat = gv('F-mat');
  if (op && mat) {
    clOp  = op;
    clMat = mat;
    // Update pills UI
    ['PC','RS','RSr','MS'].forEach(function(o) {
      document.getElementById('CL-'+o).classList.toggle('selected', o===op);
    });
    ['NAT','Z2N'].forEach(function(m) {
      document.getElementById('MAT-'+m).classList.toggle('selected', m===mat);
    });
    renderChecklist();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECKLIST OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectCLOp(op) {
  clOp = op;
  ['PC','RS','RSr','MS'].forEach(function(o) {
    document.getElementById('CL-'+o).classList.toggle('selected', o===op);
  });
  // Sync back to form
  document.getElementById('F-op').value = op;
  dotSel('d-op', document.getElementById('F-op'), 'any');
  renderChecklist();
}
function selectMat(mat) {
  clMat = mat;
  ['NAT','Z2N'].forEach(function(m) {
    document.getElementById('MAT-'+m).classList.toggle('selected', m===mat);
  });
  // Sync back to form
  document.getElementById('F-mat').value = mat;
  dotSel('d-mat', document.getElementById('F-mat'), 'any');
  renderChecklist();
}
function renderChecklist() {
  var content = document.getElementById('CL-CONTENT');
  var actions = document.getElementById('CL-ACTIONS');
  if (!clOp || !clMat) {
    content.innerHTML = '<div class="cl-empty"><div class="cl-empty-ico">ğŸ“‹</div><p>Aucune opÃ©ration sÃ©lectionnÃ©e</p><small>Choisir l\'opÃ©ration et le type de matÃ©riel<br>pour afficher la procÃ©dure technique.</small></div>';
    actions.style.display = 'none';
    return;
  }
  var data = (CL_DATA[clOp] && CL_DATA[clOp][clMat]) ? CL_DATA[clOp][clMat] : null;
  if (!data || !data.length) {
    // Try NAT fallback
    data = (CL_DATA[clOp] && CL_DATA[clOp].NAT) ? CL_DATA[clOp].NAT : null;
  }
  if (!data || !data.length) {
    content.innerHTML = '<div class="cl-empty"><div class="cl-empty-ico">ğŸ”§</div><p>' + clOp + ' ' + clMat + '</p><small>ProcÃ©dure non disponible pour ce matÃ©riel.</small></div>';
    actions.style.display = 'none';
    return;
  }
  // Add EM auto-detected badge to header
  var emSerie = '';
  var nem1el = document.getElementById('F-nem1');
  if (nem1el && nem1el.dataset.serie) emSerie = nem1el.dataset.serie;
  // Show EM mismatch warning if selected mat â‰  detected serie
  var emWarn = '';
  if (emSerie && emSerie !== clMat) {
    emWarn = '<div class="alert warn" style="margin:0 0 12px">âš ï¸ EM dÃ©tectÃ© : ' + emSerie + ' â€” vous avez sÃ©lectionnÃ© ' + clMat + '. VÃ©rifiez votre sÃ©lection.</div>';
  }
  actions.style.display = 'flex';
  var html = emWarn;
  var phaseColors = { A:'#001E62', B:'#0A3080', C:'#005F73', D:'#C8102E', E:'#1A7A3C', U:'#5C2D91' };
  var phaseLabels = { A:'OpÃ©rations prÃ©alables', B:'Mise en service', C:'VÃ©rifications complÃ©mentaires', D:'Essais d\'appareillages', E:'OpÃ©rations finales', U:'Phase unique' };
  data.forEach(function(group, gi) {
    var done = 0, total = group.items.length;
    group.items.forEach(function(it) { if (clChecked[it.id]) done++; });
    var isComplete = done === total && total > 0;
    var phaseColor = phaseColors[group.phase] || '#001E62';
    html += '<div class="checklist-phase">';
    html += '<div class="phase-header" id="PH-'+gi+'" onclick="togglePhase('+gi+')">';
    html += '<div class="phase-letter" style="background:'+phaseColor+'">'+group.phase+'</div>';
    html += '<div class="phase-title"><h4>'+esc(group.title)+'</h4><p>'+phaseLabels[group.phase]+'</p></div>';
    html += '<div class="phase-progress'+(isComplete?' complete':'')+'">'+done+'/'+total+'</div>';
    html += '<div class="phase-chevron">â€º</div>';
    html += '</div>';
    html += '<div class="phase-body" id="PB-'+gi+'">';
    group.items.forEach(function(item) {
      var checked = !!clChecked[item.id];
      html += '<div class="cl-item'+(checked?' checked':'')+'" id="CLI-'+item.id+'" onclick="toggleItem(\''+item.id+'\','+gi+')">';
      html += '<div class="cl-check"><svg width="12" height="9" viewBox="0 0 12 9" fill="none"><path d="M1 4L4.5 7.5L11 1" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
      html += '<div class="cl-content"><div class="cl-text">'+esc(item.t)+'</div>';
      if (item.sub) html += '<div class="cl-sub">'+esc(item.sub)+'</div>';
      if (item.tags) {
        item.tags.forEach(function(tag) {
          if (tag.startsWith('prereq:')) html += '<span class="cl-tag tag-prereq">âš¡ '+esc(tag.slice(7))+'</span>';
          else if (tag === 'naf')       html += '<span class="cl-tag tag-naf">â›” NE PAS FAIRE</span>';
          else if (tag === 'urgent')    html += '<span class="cl-tag tag-urgent">ğŸ”´ URGENT</span>';
          else if (tag.startsWith('ref:')) html += '<span class="cl-tag tag-ref">ğŸ“– '+esc(tag.slice(4))+'</span>';
        });
      }
      html += '</div></div>';
    });
    html += '</div></div>';
  });
  content.innerHTML = html;
  // Open first group by default
  if (data.length > 0) {
    var firstHeader = document.getElementById('PH-0');
    var firstBody   = document.getElementById('PB-0');
    if (firstHeader && firstBody) {
      firstHeader.classList.add('open');
      firstBody.classList.add('open');
    }
  }
  updatePhaseProgress();
}
function togglePhase(gi) {
  var h = document.getElementById('PH-'+gi);
  var b = document.getElementById('PB-'+gi);
  if (!h || !b) return;
  var isOpen = b.classList.contains('open');
  h.classList.toggle('open', !isOpen);
  b.classList.toggle('open', !isOpen);
}
function toggleItem(id, gi) {
  clChecked[id] = !clChecked[id];
  var el = document.getElementById('CLI-'+id);
  if (el) el.classList.toggle('checked', clChecked[id]);
  updatePhaseProgress();
  saveCLState();
}
function updatePhaseProgress() {
  if (!clOp || !clMat) return;
  var data = getClData();
  if (!data) return;
  data.forEach(function(group, gi) {
    var done = 0, total = group.items.length;
    group.items.forEach(function(it) { if (clChecked[it.id]) done++; });
    var progEl = document.querySelector('#PH-'+gi+' .phase-progress');
    if (progEl) {
      progEl.textContent = done + '/' + total;
      progEl.classList.toggle('complete', done === total && total > 0);
    }
  });
}
function getClData() {
  if (!clOp || !clMat) return null;
  var data = (CL_DATA[clOp] && CL_DATA[clOp][clMat]) ? CL_DATA[clOp][clMat] : null;
  if (!data || !data.length) {
    data = (CL_DATA[clOp] && CL_DATA[clOp].NAT) ? CL_DATA[clOp].NAT : null;
  }
  return data;
}
function resetChecklist() {
  clChecked = {};
  saveCLState();
  renderChecklist();
  toast('Checklist rÃ©initialisÃ©e', 'info');
}
function completeAll() {
  var data = getClData();
  if (!data) return;
  data.forEach(function(g) { g.items.forEach(function(i) { clChecked[i.id] = true; }); });
  saveCLState();
  renderChecklist();
  toast('âœ… Tous les Ã©lÃ©ments cochÃ©s', 'success');
}
function saveCLState() {
  try { localStorage.setItem(CL_STORE, JSON.stringify({ op: clOp, mat: clMat, checked: clChecked })); } catch(e) {}
}
function loadCLState() {
  try {
    var s = JSON.parse(localStorage.getItem(CL_STORE) || '{}');
    if (s.op)  { clOp  = s.op;  document.getElementById('CL-'+s.op)  && document.getElementById('CL-'+s.op).classList.add('selected'); }
    if (s.mat) { clMat = s.mat; document.getElementById('MAT-'+s.mat) && document.getElementById('MAT-'+s.mat).classList.add('selected'); }
    if (s.checked) clChecked = s.checked;
    if (clOp && clMat) renderChecklist();
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSTES â€” Copy to clipboard
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyPoste(info) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(info).then(function() { toast('ğŸ“‹ CopiÃ© : ' + info, 'success'); });
  } else {
    toast('ğŸ“‹ ' + info, 'info');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMESTAMPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tsAuto(w) {
  var now = new Date(); TS[w] = now;
  var s = fmtDT(now);
  if (w === 'VAE') {
    document.getElementById('F-vae-d').value = fmtD(now);
    document.getElementById('F-vae-h').value = fmtT(now);
    document.getElementById('VAE-ts-txt').textContent  = 'â± ' + s;
    document.getElementById('VAE-ts-hint').textContent = 'âœ… ' + s;
    document.getElementById('VAE-ts-hint').style.color = 'var(--green)';
  } else {
    document.getElementById('F-arr-ts-d').value = fmtD(now);
    document.getElementById('F-arr-ts-h').value = fmtT(now);
    document.getElementById('ARR-ts-txt').textContent  = 'â± ' + s;
    document.getElementById('ARR-ts-hint').textContent = 'âœ… ' + s;
    document.getElementById('ARR-ts-hint').style.color = 'var(--green)';
    dot('d-arreff', 'ok');
  }
  toast('â± ' + w + ' : ' + s, 'success');
}
function tsPreview(w) {
  var dId = w==='VAE' ? 'F-vae-d' : 'F-arr-ts-d';
  var hId = w==='VAE' ? 'F-vae-h' : 'F-arr-ts-h';
  var d = document.getElementById(dId).value;
  var h = document.getElementById(hId).value;
  if (!d || !h) return;
  var hint = document.getElementById(w+'-ts-hint');
  hint.textContent = 'â†’ ' + d.split('-').reverse().join('/') + ' ' + h + ' â€” tap Appliquer';
  hint.style.color = 'var(--amber)';
}
function tsApply(w) {
  var dId = w==='VAE' ? 'F-vae-d' : 'F-arr-ts-d';
  var hId = w==='VAE' ? 'F-vae-h' : 'F-arr-ts-h';
  var d = document.getElementById(dId).value, h = document.getElementById(hId).value;
  if (!d || !h) { toast('âš ï¸ Saisir date et heure', 'error'); return; }
  var dt = new Date(d + 'T' + h); TS[w] = dt;
  var s = fmtDT(dt);
  document.getElementById(w+'-ts-txt').textContent  = 'âœï¸ ' + s;
  document.getElementById(w+'-ts-hint').textContent = 'âœ… ' + s;
  document.getElementById(w+'-ts-hint').style.color = 'var(--green)';
  if (w === 'ARR') dot('d-arreff', 'ok');
  toast('âœ… ' + w + ' : ' + s + ' appliquÃ©', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VALIDATE & SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function valider() {
  document.querySelectorAll('.row.err').forEach(function(r) { r.classList.remove('err'); });
  var errors = [];
  var checks = [
    { id:'R-date',   fn:function(){return gv('F-date')!==''},    lbl:'Date' },
    { id:'R-train',  fn:function(){return gv('F-train')!==''},   lbl:'NÂ° Train' },
    { id:'R-op',     fn:function(){return gv('F-op')!==''},      lbl:'OpÃ©ration' },
    { id:'R-mat',    fn:function(){return gv('F-mat')!==''},     lbl:'MatÃ©riel' },
    { id:'R-compo',  fn:function(){return gv('F-compo')!==''},   lbl:'Composition' },
    { id:'R-nem1',   fn:function(){return gv('F-nem1')!==''},    lbl:'NÂ° EM' },
    { id:'R-dep',    fn:function(){return gv('F-dep-d')!==''&&gv('F-dep-h')!==''},lbl:'DÃ©part (date + heure)' },
    { id:'R-ldep',   fn:function(){return gv('F-ldep')!==''},    lbl:'Lieu DÃ©part' },
    { id:'R-ppesol', fn:function(){return gv('F-ppesol')!==''},  lbl:'PPE Sol' },
    { id:'R-sigav',  fn:function(){return gv('F-sigav')!==''},   lbl:'Signalisation d\'avant' },
    { id:'R-eas',    fn:function(){return gv('F-eas')!==''},     lbl:'EAS Bord' },
    { id:'R-portes', fn:function(){return gv('F-portes')!==''},  lbl:'Portes' },
    { id:'R-ordres', fn:function(){return gv('F-ordres')!==''},  lbl:'Remise d\'ordres' },
    { id:'R-annonce',fn:function(){return gv('F-annonce')!==''},  lbl:'Annonce' },
    { id:'R-aum',    fn:function(){return gv('F-aum')!==''},     lbl:'AuM' },
    { id:'R-smc',    fn:function(){return gv('F-smc')!==''},     lbl:'SIRIUS Mode Conduite' },
  ];
  checks.forEach(function(c) {
    if (!c.fn()) { errors.push(c.lbl); if (c.id) { var el = document.getElementById(c.id); if (el) el.classList.add('err'); } }
  });
  if (errors.length) {
    toast('âš ï¸ ' + errors.length + ' champ(s) requis : ' + errors.slice(0,3).join(', ') + (errors.length>3?' â€¦':''), 'error');
    // Scroll to first error
    var firstErr = document.querySelector('.row.err');
    if (firstErr) firstErr.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }
  var entry = {
    date:gv('F-date'), journee:gv('F-jour'), train:gv('F-train'), indice:gv('F-indice'),
    op:gv('F-op'), mat:gv('F-mat'), compo:gv('F-compo'), nem1:gv('F-nem1'), nem2:gv('F-nem2'),
    depD:gv('F-dep-d'), depH:gv('F-dep-h'), hd:document.getElementById('HD-box').textContent,
    ldep:gv('F-ldep'), arrD:gv('F-arr-d'), arrH:gv('F-arr-h'), larr:gv('F-larr'),
    arrEff: TS.ARR ? fmtDT(TS.ARR) : '',
    ppesol:gv('F-ppesol'), sigav:gv('F-sigav'), va:gv('F-va'), kvb:gv('F-kvb'), rst:gv('F-rst'),
    eas:gv('F-eas'),
    gsmgfu:gv('F-gsmgfu'), carnbord:gv('F-carnbord'), surcharge:gv('F-surcharge'), odiceo:gv('F-odiceo'),
    portes:gv('F-portes'), ordres:gv('F-ordres'), annonce:gv('F-annonce'),
    aum:gv('F-aum'), smc:gv('F-smc'), sad:gv('F-sad'), vae:gv('F-vae'),
    vaeTs: TS.VAE ? fmtDT(TS.VAE) : '', vamarche:gv('F-vamarche'),
    obs:document.getElementById('F-obs').value,
    rex:gv('F-rex'), docadc:gv('F-docadc'), docnum:gv('F-docnum'),
    at: fmtDT(new Date())
  };
  var hist = loadHist();
  hist.unshift(entry);
  saveHist(hist);
  toast('âœ… Prise de service enregistrÃ©e', 'success');
  updateCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmReset() {
  showSheet('ğŸ”„ RÃ©initialiser',
    '<p>Effacer tous les champs du formulaire ?</p><p>L\'historique sera conservÃ©.</p>',
    [
      { lbl:'âš ï¸ Oui, rÃ©initialiser', cls:'btn btn-danger', fn:'doReset(); closeSheet()' },
      { lbl:'Annuler', cls:'btn btn-sec', fn:'closeSheet()' }
    ]
  );
}
function doReset() {
  var ids = ['F-date','F-jour','F-train','F-indice','F-op','F-mat','F-compo','F-nem1','F-nem2',
    'F-dep-d','F-dep-h','F-ldep','F-arr-d','F-arr-h','F-larr','F-ppesol',
    'F-sigav','F-va','F-kvb','F-rst','F-eas','F-gsmgfu','F-carnbord','F-surcharge','F-odiceo',
    'F-portes','F-ordres','F-annonce','F-aum','F-smc','F-sad','F-vae','F-vae-d','F-vae-h',
    'F-arr-ts-d','F-arr-ts-h','F-obs','F-rex','F-docadc','F-docnum','F-vamarche'];
  ids.forEach(function(id) { var el = document.getElementById(id); if (el) el.value = ''; });
  // Reset selects styling
  document.querySelectorAll('select').forEach(function(s) {
    s.classList.remove('ok-select','ko-select');
  });
  // Reset dots
  document.querySelectorAll('.dot').forEach(function(d) { d.className = 'dot'; });
  // Reset boxes
  document.getElementById('HD-box').textContent = '--:--';
  document.getElementById('HD-sub').textContent = 'Auto depuis DÃ©part PrÃ©vu';
  // Reset banners
  ['BAN-ppe','BAN-st'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) { el.style.background = ''; el.style.color = ''; }
  });
  document.getElementById('BAN-ppe-t').textContent = 'PPE Bord â€” En attente de saisie';
  document.getElementById('BAN-st-t').textContent  = 'Service Train â€” En attente de saisie';
  // Reset alerts
  ['AL-eas','AL-sirius','AL-oae','AL-odiceo','AL-rex'].forEach(function(id) { show(id, false); });
  show('R-docnum', false);
  show('R-nem2', false);
  show('VAE-ts-block', false);
  // Reset timestamps
  TS.VAE = null; TS.ARR = null;
  document.getElementById('VAE-ts-txt').textContent  = 'Non horodatÃ©e';
  document.getElementById('ARR-ts-txt').textContent  = 'Non horodatÃ©e';
  document.getElementById('VAE-ts-hint').textContent = 'Saisir l\'heure exacte de la VAE';
  document.getElementById('VAE-ts-hint').style.color = '';
  document.getElementById('ARR-ts-hint').textContent = 'Heure d\'arrivÃ©e effective (optionnel)';
  document.getElementById('ARR-ts-hint').style.color = '';
  // Reset errors
  document.querySelectorAll('.row.err').forEach(function(r) { r.classList.remove('err'); });
  // Reset EM labels
  isUM = false;
  document.getElementById('LBL-nem1').textContent = 'NÂ° EM';
  document.getElementById('SUB-nem1').textContent = "Choisir la composition d'abord";
  // Restore today
  setToday('F-date'); setToday('F-dep-d');
  dot('d-date', 'ok'); dot('d-dep', 'ok');
  updateProgress();
  toast('ğŸ”„ Formulaire rÃ©initialisÃ©', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHist() {
  var hist = loadHist();
  updateCount();
  var el = document.getElementById('HIST-list');
  if (!hist.length) {
    el.innerHTML = '<div class="hist-empty"><div class="ei">ğŸ“‹</div><p>Aucune prise de service enregistrÃ©e.</p></div>';
    return;
  }
  el.innerHTML = hist.map(function(e) {
    var ppeOK = e.sigav==='OK' && e.va==='OK' && e.kvb==='OK' && e.rst==='OK' && e.eas==='OK';
    var stOK  = e.portes==='OK' && e.ordres==='OK' && e.annonce==='OK';
    var d = new Date(e.date);
    var ds = isNaN(d.getTime()) ? (e.date||'') : d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
    return (
      '<div class="hist-card">' +
        '<div class="hist-card-head">' +
          '<span class="hist-train">ğŸš„ ' + esc(e.train||'â€”') + (e.mat?' Â· '+esc(e.mat):'') + '</span>' +
          '<span class="hist-date">' + esc(ds) + '</span>' +
        '</div>' +
        '<div class="hist-body">' +
          '<div class="hist-grid">' +
            hci('JournÃ©e', e.journee) + hci('OpÃ©ration', e.op) +
            hci('Composition', e.compo) + hci('HD', e.hd) +
            hci('NÂ°EM Paris', e.nem1) + hci('NÂ°EM Province', e.nem2||'â€”') +
            hci('Lieu DÃ©part', e.ldep) + hci('Lieu ArrivÃ©e', e.larr||'â€”') +
            hci('AuM', e.aum) + hci('VAE', e.vae) +
            hci('SIRIUS MC', e.smc) + hci('SIRIUS AD', e.sad) +
            '<div class="hist-ci"><label>PPE Bord</label><span>' + badge(ppeOK?'OK':'KO') + '</span></div>' +
            '<div class="hist-ci"><label>Service Train</label><span>' + badge(stOK?'OK':'KO') + '</span></div>' +
          '</div>' +
          (e.obs ? '<div class="hist-obs">ğŸ’¬ ' + esc(e.obs) + '</div>' : '') +
          '<div style="margin-top:8px;font-size:10px;color:var(--text3)">EnregistrÃ© le ' + esc(e.at) + '</div>' +
        '</div>' +
      '</div>'
    );
  }).join('');
}
function hci(l, v) { return '<div class="hist-ci"><label>'+l+'</label><span>'+esc(v||'â€”')+'</span></div>'; }
function badge(v) { return '<span class="badge-'+(v==='OK'?'ok':'ko')+'">'+v+'</span>'; }
function updateCount() {
  var n = loadHist().length;
  document.getElementById('HIST-cnt').textContent = n;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  var hist = loadHist();
  if (!hist.length) { toast('Aucune donnÃ©e Ã  exporter', 'error'); return; }
  var hd = ['Date','JournÃ©e','Train','Indice','OpÃ©ration','MatÃ©riel','Compo','NÂ°EM Paris','NÂ°EM Province',
    'Date DÃ©part','Heure DÃ©part','HD','Lieu DÃ©part','Date ArrivÃ©e','Heure ArrivÃ©e','Lieu ArrivÃ©e',
    'ArrivÃ©e Effective','PPE Sol','Sig Avant','VA','KVB','RST','EAS',
    'GSM-GFU','Carnet Bord','Surcharge','ODICEO',
    'Portes','Remise Ordres','Annonce','AuM','SIRIUS MC','SIRIUS AD','VAE','Heure VAE','VA Marche',
    'Observations','REX','DocADC','NÂ° Doc','EnregistrÃ© le'];
  var rows = [hd.join(';')];
  hist.forEach(function(e) {
    rows.push([
      e.date, e.journee, e.train, e.indice, e.op, e.mat||'', e.compo, e.nem1, e.nem2||'',
      e.depD, e.depH, e.hd, e.ldep, e.arrD||'', e.arrH||'', e.larr||'',
      e.arrEff||'', e.ppesol, e.sigav, e.va, e.kvb, e.rst, e.eas,
      e.gsmgfu||'', e.carnbord||'', e.surcharge||'', e.odiceo||'',
      e.portes, e.ordres, e.annonce, e.aum, e.smc, e.sad, e.vae, e.vaeTs||'', e.vamarche||'',
      (e.obs||'').replace(/;/g,','), e.rex||'', e.docadc||'', e.docnum||'', e.at
    ].map(function(v) { return '"' + String(v||'').replace(/"/g,'""') + '"'; }).join(';'));
  });
  var blob = new Blob(['\uFEFF'+rows.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'pds_fmn_' + fmtD(new Date()).replace(/-/g,'') + '.csv';
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('âœ… CSV exportÃ©', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _ls = (function() { try { localStorage.setItem('_t','1'); localStorage.removeItem('_t'); return true; } catch(e) { return false; } })();
var _fb = [];
function loadHist() { if (_ls) { try { return JSON.parse(localStorage.getItem(STORE)||'[]'); } catch(e) { return []; } } return _fb; }
function saveHist(a) { if (_ls) { try { localStorage.setItem(STORE, JSON.stringify(a)); return; } catch(e) {} } _fb = a; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHEET / OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSheet(title, body, btns) {
  var html = '<div class="sh-title">'+title+'</div><div class="sh-body">'+body+'</div>' +
    '<div class="sh-btns">'+btns.map(function(b) {
      return '<button class="'+b.cls+'" onclick="'+b.fn+'">'+b.lbl+'</button>';
    }).join('')+'</div>';
  document.getElementById('OVL-BODY').innerHTML = html;
  document.getElementById('OVL').classList.add('on');
}
function closeSheet() { document.getElementById('OVL').classList.remove('on'); }
function ovlBg(e)     { if (e.target.id==='OVL') closeSheet(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHelp() {
  showSheet('â„¹ï¸ Aide â€” FMN v3',
    '<p><strong>Voyants :</strong><br>' +
    '<span style="color:var(--green)">â— Vert</span> = OK &nbsp; ' +
    '<span style="color:var(--red)">â— Rouge</span> = KO &nbsp; ' +
    '<span style="color:var(--blue)">â— Bleu</span> = Info</p>' +
    '<p><strong>EAS</strong> = Essai Automatique de SÃ©curitÃ© (anciennement EFAS)</p>' +
    '<p><strong>HD</strong> = calculÃ© automatiquement depuis l\'heure de dÃ©part saisie</p>' +
    '<p><strong>Checklist</strong> â€” sÃ©lectionner opÃ©ration + matÃ©riel pour afficher la procÃ©dure complÃ¨te (PC/RS/RSr/MS Ã— NAT/Z2N)</p>' +
    '<p><strong>Postes</strong> â€” contacts des postes Paris-Est &amp; cantons. Appui = copie presse-papier.</p>' +
    '<p><strong>D 25.02</strong> â€” Commander SURCHARGE au desserrage + Essai VA en marche obligatoire</p>' +
    '<p><strong>Installer</strong> : Safari â†’ Partager â†’ Â« Sur l\'Ã©cran d\'accueil Â»</p>' +
    '<p><span class="sh-ref-chip">FMN v02</span><span class="sh-ref-chip">Septembre 2025</span><span class="sh-ref-chip">Paris-Est</span></p>',
    [{ lbl:'Fermer', cls:'btn btn-sec', fn:'closeSheet()' }]
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _tt;
function toast(msg, type) {
  var el = document.getElementById('TOAST');
  el.textContent = msg;
  el.style.background = type==='success'?'var(--green)':type==='error'?'var(--red)':'var(--navy-mid)';
  el.style.color = '#fff';
  clearTimeout(_tt);
  el.classList.add('on');
  _tt = setTimeout(function() { el.classList.remove('on'); }, 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function g(id, el) { var e = document.getElementById(id); return el ? e : (e ? e.value : ''); }
function gv(id) { var e = document.getElementById(id); return e ? e.value : ''; }
function show(id, v) { var el = document.getElementById(id); if (!el) return; el.classList.toggle('hidden', !v); }
function pad(n) { return n < 10 ? '0'+n : ''+n; }
function fmtD(d)  { return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function fmtT(d)  { return pad(d.getHours())+':'+pad(d.getMinutes()); }
function fmtDT(d) { return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+fmtT(d); }
function esc(s)   { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
